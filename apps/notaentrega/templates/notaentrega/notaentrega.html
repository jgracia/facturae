{% extends "base.html" %}

{% block title %} Crear Nota de Entrega {% endblock title %}

{% load static %}

{% block extra_head %}
  <!-- librerías typeahead -->
  <link rel="stylesheet" type="text/css" href="{% static 'vendor/typeahead/css/typeaheadjs.css' %}">
  <link rel="stylesheet" type="text/css" href="{% static 'vendor/typeahead/css/typeaheadbundle.css' %}">

  <!--<link rel="stylesheet" type="text/css" href="{% static 'vendor/select2/css/select2.min.css' %}">
  <link rel="stylesheet" type="text/css" href="{% static 'vendor/select2/css/select2-bootstrap4.min.css' %}">-->


  <!-- librerías bootstrap-datetimepicker -->
  <link rel="stylesheet" type="text/css" href="{% static 'vendor/bootstrap-datepicker/css/bootstrap-datepicker.min.css' %}">

  <!-- librerías FormValidation -->
  <link rel="stylesheet" type="text/css" href="{% static 'vendor/formvalidation/css/formValidation.min.css' %}">

  <link rel="stylesheet" href="{% static 'css/_estilo_tabla_articulos.css' %}">

  <style>
    /* scrooll para typeahead */
    #scrollable-dropdown-menu .tt-menu {
        max-height: 250px;
        overflow-y: auto;
        /*background-color: red;*/
    }

    #prefetch_customer .tt-menu {
        max-height: 250px;
        overflow-y: auto;
    }

    /* estilo tabla adaptable */
    td.numeric, th.numeric { text-align: right; }
      #resultTable td.red {color: red; font-weight: bold}
      #resultTable td.coral {color: coral; font-weight: bold}

    /* scroll tabla carrito */
    .table-wrapper-scroll-y {
      display: block;
      max-height: 380px;
      overflow-y: auto;
      overflow-x: auto;
      -ms-overflow-style: -ms-autohiding-scrollbar;
    }

    /*.imagebacked {
      padding: 10px 0 2px 40px;
      background-repeat: no-repeat;
      background-position: 1px 2px;
      vertical-align: middle;
    }

    /* Override to make the feedback icons shown properly */
    /*.form-horizontal .has-feedback .form-control-feedback {
        top: 0;
        right: -15px;
    }
    .form-horizontal .has-feedback .input-group .form-control-feedback {
        top: 0;
        right: -30px;
    }*/

    /* letra acceso directo */
    *[accesskey]:after {content:' [' attr(accesskey) ']'}
  </style>

{% endblock extra_head %}

{% block content %}
<div class="base_container">
  <div class="col-12">
    <div class="row">
      <!-- Mixed: mobile, tablet, and desktop -->
      <div class="col-6 col-sm-6 col-lx-6">
        <h4>Notas de Entrega</h4>
      </div>
      <div class="col-6 col-sm-6 col-lx-6">
        <div class="btn-group float-right" role="group" aria-label="Acciones">
          <button type="button" class="btn btn-primary btn-sm"
                  id="LoadXML">
                  <i class="fas fa-plus"></i> Nuevo
          </button>
          <button type="button" class="btn btn-secondary btn-sm"
                  onclick="location.href='{{ request.META.HTTP_REFERER }}';">
                  <i class="fas fa-undo"></i> Regresar
          </button>
        </div>
      </div>
    </div>
    <hr/>

    <div class="row">
      <div class="col-12 col-xl-8 mb-2">
        <div class="row">
          <div class="col-12 col-xl-7">

            <input type="hidden" name="txtRazonSocialID" id="txtRazonSocialID" value="0">
            <div class="form-group">
              <h5>Cliente</h5>
              <div id="prefetch_customer">
                <input type="text" class="form-control typeahead border-primary tt-query"
                  autocomplete="off" spellcheck="false" id="typeahead_razon_social" placeholder="Nombre o RUC" data-provide="typeahead">
              </div>
              <small class="float-right">Cliente no listado aquí? <a href="#" onclick="return abrir_modal('{% url 'venta:crear_cliente_modal' %}')">Agregar nuevo</a> </small>
            </div>


            <!--<select class="js-example-basic-single" name="state">
              <option value="AL">Alabama</option>
              <option value="WY">Wyoming</option>
            </select>-->

            <!--
            <div class="form-group">
              <label>Example of select with optgroup</label>
              <select data-placeholder="Choose one thing" data-allow-clear="1">
                <option></option>
                <optgroup label="Group A">
                  <option>A1</option>
                  <option>A2</option>
                  <option>A3</option>
                </optgroup>
                <optgroup label="Group B">
                  <option>B1</option>
                  <option>B2</option>
                  <option>B3</option>
                </optgroup>
              </select>
            </div>
            -->
          </div>

          <div class="col-6 col-xl-2">
            <label for="id_fuente">Precio</label>
            <select  class="form-control" id="id_precio">
              <option value="precio_uno">Precio 1</option>
              <option value="precio_dos">Precio 2</option>
              <option value="precio_tres">Precio 3</option>
              <option value="precio_cuatro">Precio 4</option>
            </select>
          </div>

          <div class="col-6 col-xl-3">
            <label for="datepicker">Fecha</label>
            <input type="date" class="form-control" id="datepicker" value={{ fecha_emision }} placeholder="DD/MM/AAAA">
          </div>

          <!--
          <div class="col-lg-2 col-md-2 col-sm-6">
            <label for="numero_comprobante">Nro. Comprobante</label>
            <input type="text" class="form-control" id="numero_comprobante" data-inputmask="'mask': '999-999-999999999'" placeholder="001-001-000000001" data-toggle="tooltip" title="Nro. Comprobante">
          </div>
          -->
        </div>
        <!-- /.row -->

        <br>
        <div class="row">
          <div class="col-12">
            <div class="form-group">
              <div id="scrollable-dropdown-menu">
                <input type="text" class="typeahead tt-query form-control" autocomplete="off" spellcheck="false" id="typeahead_producto" placeholder="Buscar producto...">
              </div>
              <small class="float-right">Producto no listado aquí? <a href="#"data-toggle="modal" data-target="#addProductTypeModal">Agregar nuevo</a> </small>
            </div>
          </div>
        </div>
        <!-- /.row -->

        <div class="row">
          <div class="col-12">
            <!-- Begin Table -->
            {% load my_filters %}
            <!-- Fixed header table-->
            <div class="card">
              <div class="card-body p-2">
                <div class="table-wrapper-scroll-y">
                  <section id="flip-scroll">
                    <table id="tbl_article" class="table table-bordered table-striped">
                      <thead class="cf">
                        <tr>
                          <th style="display:none;">ID</th>
                          <th>Descripción</th>
                          <th class="numeric">Cantidad</th>
                          <th>Und</th>
                          <th class="numeric">Precio</th>
                          <th class="numeric">Total</th>
                          <th class="text-center">Acciones</th>
                        </tr>
                      </thead>
                      <tbody>
                        {% load concat_string %}

                        {% load cesta_tags %}
                        {% get_cesta "CART-NOTAENTREGA" request.session.company_id as cesta %}

                        {% if cesta.obtener_items %}
                        {% for item in cesta.obtener_items %}
                        <tr>
                          <td style="display:none;">{{ item.id }}</td>

                          {% if item.tipo == 'PROD' %}
                          <td><a href=/producto/detalle_producto/{{item.producto.producto_id}} target='_blank'>{{ item.producto.nombre }}</a></td>
                          {% else %}
                          <td><a href=/servicio/detalle_servicio/{{item.servicio.servicio_id}} target='_blank'>{{ item.servicio.nombre }}</a></td>
                          {% endif %}
                          <td class='numeric'>{{ item.cantidad|floatformat:2 }}</td>
                          <td>{{ item.unidad_medida.abreviatura }}</td>
                          <td class='numeric'>{{ item.precio|currency }}</td>
                          <td class='numeric'>{{ item.valor_subtotal_sin_impuesto|currency }}</td>
                          <td class="text-center">
                            {% if item.tipo == 'SERV' %}
                              <div class="btn-group btn-group-sm">
                                <button type="button" data-id="{{ 'SRV-'|concat_string:item.pk }}"
                                  class="btn btn-primary editButton"><i class='fas fa-edit'></i></button>
                              </div>
                              <div class="btn-group btn-group-sm">
                                <button type="button" class="btn btn-info searchButton" disabled><i class='fas fa-search'></i></button>
                              </div>
                              <div class="btn-group btn-group-sm">
                                <button type="button" data-id="{{ 'SRV-'|concat_string:item.pk }}"
                                class="btn btn-warning deleteButton"><i class='fas fa-trash'></i></button>
                              </div>
                            {% else %}
                              <div class="btn-group btn-group-sm">
                                <button type="button" data-id="{{ item.pk }}"
                                  class="btn btn-primary editButton"><i class='fas fa-edit'></i></button>
                              </div>
                              {% if item.producto.tiene_vencimiento or item.producto.tiene_serie %}
                                <div class="btn-group btn-group-sm">
                                  <button type="button" data-id="{{ item.pk }}"
                                  class="btn btn-info searchButton"><i class='fas fa-search'></i></button>
                                </div>
                              {% else %}
                                <div class="btn-group btn-group-sm">
                                  <button type="button" class="btn btn-default" disabled><i class='fas fa-search'></i></button>
                                </div>
                              {% endif %}
                              <div class="btn-group btn-group-sm">
                                <button type="button" data-id="{{ item.pk }}"
                                  class="btn btn-warning deleteButton"><i class='fas fa-trash'></i></button>
                              </div>
                            {% endif %}
                          </td>
                        </tr>
                        {% endfor %}
                        {% endif %}

                        <!-- agregar mensaje NO HAY ITEMS -->
                        {% if cesta.obtener_total_filas == 0 %}
                        <tr>
                          <td colspan="6" align="center"
                          bgcolor="Gainsboro" data-title="Productos & Servicios"><font color="OrangeRed">¡ Ningún dato disponible en el carrito !</font></td>
                        </tr>
                        {% endif %}
                      </tbody>
                    </table>
                  </section>
                </div>
                <!-- /.table-wrapper-scroll-y -->
              </div>
            </div>
            <!-- /.card -->
          </div>
        </div>
        <!-- /.row -->
      </div>
      <!-- /.col-xl-8 -->

      <div class="col-12 col-xl-4">
        <div class="card">
          <div class="card-header">
            <i class="fas fa-dollar-sign"></i> TOTAL
          </div>
          <div class="card-body">
            <div class="form-group text-center">
              <label class="col-12 control-label" id="lblGrandTotal" align="center"
              style="font-size: 40pt;">{{ cesta.obtener_gran_total|currency }}</label>
            </div>
            <div class="line col-10 offset-1" style="border-bottom: 1px solid #ccc;"></div>
            <!-- subtoal -->
            <div class="col-12">
              <br>
            </div>
            <div class="col-12">
              <label class="col-6">Subtotal</label>
              <label class="col-6 float-right"><span class="float-right" id="lblSubtotal">{{ cesta.obtener_sub_total|currency }}</span></label>
            </div>

            <div class="col-12">
              <label class="col-6">Descuento</label>
              <label class="col-6 float-right"><span class="float-right" id="lblLocalDiscount">{{ cesta.obtener_total_descuento|currency }}</span></label>
            </div>

            <div class="col-12">
              <label class="col-6">Tarifa 0%</label>
              <label class="col-6 float-right"><span class="float-right" id="lblSubtotalFree">{{ cesta.obtener_total_tarifa_cero|currency }}</span></label>
            </div>

            <div class="col-12">
              <label class="col-6">Tarifa {{ tarifa }}%</label>
              <label class="col-6 float-right"><span class="float-right" id="lblSubtotalBase">{{ cesta.obtener_base_imponible|currency }}</span></label>
            </div>

            <div class="col-12">
              <label class="col-6">Iva {{ tarifa }}%</label>
              <label class="col-6 float-right"><span class="float-right" id="lblLocalTax">{{ cesta.obtener_total_iva|currency }}</span></label>
            </div>
            <div class="col-12">
              <label class="col-6">TOTAL</label>
              <label class="col-6 float-right"><span class="float-right" id="lblTotal">{{ cesta.obtener_gran_total|currency }}</span></label>
            </div>
          </div>
        </div>
        <!-- /.card -->

        <!--
        <br>
        <div class="row">
          <div class="col-12">
            <div class="card">
              <div class="card-header">
                <i class="fa fa-shopping-cart fa-fw"></i> Pagos
              </div>
              <div class="card-body">
                <div class="btn-group" role="group" aria-label="Button group with nested dropdown">
                  <button type="button" class="btn btn-secondary js-cash-payment"
                    data-url="/cesta/total_filas_cesta/?key=CART-VENTA"
                    data-toggle="tooltip" title="EFECTIVO ALT+C" accesskey="C">
                    <i class="fas fa-money-bill"></i> EFECTIVO</button>
                  <button type="button" class="btn btn-secondary js-bank-transfer"
                    data-url="/cesta/total_filas_cesta/?key=CART-VENTA"
                    data-toggle="tooltip" title="TRANSFERENCIA ALT+T" accesskey="T">
                    <span style="color: #f0ad4e;">
                      <i class="fas fa-exchange-alt"></i>
                    </span>
                    TRANSF.</button>
                  <div class="btn-group" role="group">
                    <button id="btnGroupDrop1" type="button" class="btn btn-secondary dropdown-toggle"
                      data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                      OTROS
                    </button>
                    <div class="dropdown-menu" aria-labelledby="btnGroupDrop1">
                      <a class="dropdown-item js-bank-cheque"
                        data-url="/cesta/total_filas_cesta/?key=CART-VENTA" href="#">
                        <i class="far fa-credit-card"></i> CHEQUE</a>
                      <a class="dropdown-item js-card"
                        data-url="/cesta/total_filas_cesta/?key=CART-VENTA" href="#">
                        <i class="far fa-credit-card"></i> TARJETA</a>
                      <a class="dropdown-item js-comm-credit"
                        data-url="/cesta/total_filas_cesta/?key=CART-VENTA" href="#">
                        <i class="fas fa-calendar"></i> CRÉDITO</a>
                    </div>
                  </div>
                </div>
                <section id="flip-scroll">
                  <table id="tbl_payments" class="table table-bordered table-condensed cf">
                    <thead class="cf">
                      <tr>
                        <th style="display:none;">ID</th>
                        <th>Descripción</th>
                        <th class="text-center">Tipo</th>
                        <th class="numeric">$ Monto</th>
                        <th class="text-center">Acción</th>
                      </tr>
                    </thead>
                    <tbody id="tbody_payments_data">
                      <tr>
                        <td colspan="4" style = "text-align: center;"
                        bgcolor="Gainsboro" data-title="Información de Pagos"><font color="OrangeRed">¡ Ningún registro encontrado !</font></td>
                      </tr>
                    </tbody>
                  </table>
                </section>
              </div>
            </div>
          </div>
        </div>
        -->

      </div>
      <!-- /.col-xl-4 -->
    </div>
    <!-- /.row -->

    <br>
    <div class="row">
      <div class="col-12">
        <!--<button
          class="btn btn-secondary btn-sm" type="reset" class="btn btn-warning" id="empty_shopping_cart">Cancelar</button>
        <button type="reset" class="btn btn-warning" id="empty_shopping_cart">
          <i class='fas fa-trash'></i> Vaciar</button>
        <button type="submit" class="btn btn-primary btn-sm" id="saveButton">
          <i class="fas fa-save"></i> Guardar</button>-->

          <article class="card">
            <!--<div class="card-body p-5">-->
            <div class="card-body p-3">

            <!--<ul class="nav bg-light nav-pills rounded nav-fill mb-3" role="tablist">-->
            <ul class="nav bg-light nav-pills rounded nav-fill mb-1" role="tablist">
              <li class="nav-item">
                <a class="nav-link active js-cash-payment" data-url="/cesta/total_filas_cesta/?key=CART-VENTA" data-toggle="pill" href="#nav-tab-cash" accesskey="C">
                <i class="fas fa-money-bill"></i>  EFECTIVO</a></li>
              <li class="nav-item">
                <a class="nav-link js-bank-transfer" data-url="/cesta/total_filas_cesta/?key=CART-VENTA" data-toggle="pill" href="#nav-tab-bank" accesskey="T">
                <i class="fa fa-university"></i>  <em>T</em>RANSFEENCIA BANCARIA</a></li>
              <li class="nav-item">
                <a class="nav-link js-bank-cheque" data-url="/cesta/total_filas_cesta/?key=CART-VENTA" data-toggle="pill" href="#nav-tab-cheque" accesskey="Q">
                <i class="fas fa-money-check"></i> CHEQUE</a></li>
              <li class="nav-item">
                <a class="nav-link js-card" data-url="/cesta/total_filas_cesta/?key=CART-VENTA" data-toggle="pill" href="#nav-tab-card" accesskey="R">
                <i class="fa fa-credit-card"></i> TARJETA CRÉDITO</a></li>
              <li class="nav-item">
                <a class="nav-link js-comm-credit" data-url="/cesta/total_filas_cesta/?key=CART-VENTA" data-toggle="pill" href="#nav-tab-comm" accesskey="M">
                <i class="fa fa-credit-card"></i> CRÉDITO COMERCIAL</a></li>
            </ul>

            </div> <!-- card-body.// -->
          </article> <!-- card.// -->

      </div>
    </div>
    <!-- /.row -->

  </div>
</div>

  <!-- FORMULARIO EDITAR ITEM -->
  {% include 'includes/_edit_item_form.html' %}

  <!-- FORMULARIO LOTE -->
  {% include 'includes/_lote_form_salida.html' %}

  <!-- FORMULARIOS DE PAGO -->
  <!--{##% include 'includes/_pago_efectivo.html' %##}-->

  {% include 'includes/_pago_transferencia.html' %}

  {% include 'includes/_pago_cheque.html' %}

  {% include 'includes/_pago_tarjeta.html' %}

  {% include 'includes/_pago_credito_comercial.html' %}

  <!-- formulario modal proveedor -->
  <div id="popup" class="modal fade" role="dialog">

  </div>
{% endblock content %}

{% block extra_script %}
  <!-- librerías typeahead -->
  <script src="{% static 'vendor/typeahead/js/typeahead.bundle.js' %}"></script>

  <!--<script src="{% static 'vendor/select2/js/select2.min.js' %}"></script>-->

  <!-- librerías bootstrap-datetimepicker -->
  <script src="{% static 'vendor/bootstrap-datepicker/js/bootstrap-datepicker.min.js' %}"></script>
  <script src="{% static 'vendor/bootstrap-datepicker/locales/bootstrap-datepicker.es.min.js' %}"></script>

  <!-- librerías FormValidation -->
  <script src="{% static 'vendor/formvalidation/js/FormValidation.min.js' %}"></script>
  <script src="{% static 'vendor/formvalidation/js/plugins/Bootstrap.min.js' %}"></script>

  <!-- librerías bootbox -->
  <script src="{% static 'vendor/bootbox/bootbox.min.js' %}"></script>

  <!-- jquery.inputmask -->
  <script src="{% static 'vendor/inputmask/jquery.inputmask.min.js' %}"></script>

  <!-- librerías csrftoken protección csrf  -->
  <script src="{% static 'js/proteccion_csrf.js' %}"></script>

  <!-- formularios de pagos -->
  <!--<script src="{% static 'js/pago_cash.js' %}"></script>-->
  <script src="{% static 'js/pago_bank_transfer.js' %}"></script>
  <script src="{% static 'js/pago_bank_cheque.js' %}"></script>
  <script src="{% static 'js/pago_card.js' %}"></script>
  <script src="{% static 'js/pago_commercial_credit.js' %}"></script>
  <!--<script src="{% static 'js/web_socket_print.js' %}"></script>-->

  <script type="text/javascript">
    // Initialize InputMask
    $(":input").inputmask();

    /*$(document).ready(function() {
      $('.js-example-basic-single').select2();
    });

    $('select').select2({
      theme: 'bootstrap4',
    });*/

    /*$(function () {
      $('select').each(function () {
        $(this).select2({
          theme: 'bootstrap4',
          width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style',
          placeholder: $(this).data('placeholder'),
          allowClear: Boolean($(this).data('allow-clear')),
        });
      });
    });*/


    // función para mostrar formulario modal cliente
    function abrir_modal(url)
    {
      $('#popup').load(url, function()
      {
        $(this).modal('show');
      });
      return false;
    }

    function cerrar_modal()
    {
      $('#popup').modal('hide');
      return false;
    }

    document.addEventListener('DOMContentLoaded', function(e) {
      // constantes lote
      const etiquetaValidators = {
          validators: {
              notEmpty: {
                  message: 'Lote requerido'
              }
          }
      };
      const fechacaducidadValidators = {
          validators: {
              notEmpty: {
                  message: 'Fecha requerida'
              },
          }
      };
      const cantidadValidators = {
          validators: {
              notEmpty: {
                  message: 'La cantidad es requerida'
              },
              numeric: {
                  message: 'La cantidad debe ser un número',
                  // The default separators
                  thousandsSeparator: '',
                  decimalSeparator: ','
              },
          }
      };

      const loteForm = document.getElementById('loteForm');
      const fv_lote = FormValidation.formValidation(loteForm, {
        fields: {
          'lote[0].etiqueta': etiquetaValidators,
          'lote[0].fecha_caducidad': fechacaducidadValidators,
          'lote[0].cantidad': cantidadValidators,
        },
        plugins: {
          trigger: new FormValidation.plugins.Trigger(),
          bootstrap: new FormValidation.plugins.Bootstrap(),
          submitButton: new FormValidation.plugins.SubmitButton(),
          icon: new FormValidation.plugins.Icon({
            valid: 'fa fa-check',
            invalid: 'fa fa-times',
            validating: 'fa fa-refresh',
          }),
        },
      })
      .on('core.form.valid', function() {

        var values_lote = $("input[name='lote[0].etiqueta']")
          .map(function(){return $(this).val();}).get();
        var values_expire = $("input[name='lote[0].fecha_caducidad']")
          .map(function(){return $(this).val();}).get();
        var values_cantidad = $("input[name='lote[0].cantidad']")
          .map(function(){return $(this).val();}).get();

        var data = {
          'array_error': [''],
          'loteArray' : values_lote,
          'expiraArray' : values_expire,
          'qtyArray': values_cantidad
        };

        // The url and method might be different in your application
        $.ajax({
          url: "{% url 'venta:seleccionar_lote' %}",
          method: 'POST',
          data: $(loteForm).serialize() + $.param(data),
          success: function(response, textStatus, xhr) {
            if (response.success == true) {
              // Hide the dialog
              $(loteForm).parents('.bootbox').modal('hide');
            }
          },
          error : function(xhr, textStatus, errorThrown) {
            mensaje(textStatus, 'error');
          }
        });
      });

      const removeRow = function(rowIndex) {
        const row = loteForm.querySelector('[data-row-index="' + rowIndex + '"]');

        // Remove field
        fv_lote.removeField('lote[' + rowIndex + '].etiqueta')
            .removeField('lote[' + rowIndex + '].fecha_caducidad')
            .removeField('lote[' + rowIndex + '].cantidad');

        // Remove row
        row.parentNode.removeChild(row);
      };

      const template = document.getElementById('template');
      let rowIndex = 0;
      document.getElementById('addButton').addEventListener('click', function() {
        rowIndex++;

        const clone = template.cloneNode(true);
        clone.removeAttribute('id');

        // Show the row
        clone.style.display = 'block';

        clone.setAttribute('data-row-index', rowIndex);

        // Insert before the template
        template.before(clone);

        clone.querySelector('[data-name="lote.etiqueta"]').setAttribute('name', 'lote[' + rowIndex + '].etiqueta');
        clone.querySelector('[data-name="lote.fecha_caducidad"]').setAttribute('name', 'lote[' + rowIndex + '].fecha_caducidad');
        clone.querySelector('[data-name="lote.cantidad"]').setAttribute('name', 'lote[' + rowIndex + '].cantidad');

        // Add new fields
        fv_lote.addField('lote[' + rowIndex + '].etiqueta', etiquetaValidators)
            .addField('lote[' + rowIndex + '].fecha_caducidad', fechacaducidadValidators)
            .addField('lote[' + rowIndex + '].cantidad', cantidadValidators);

        // Handle the click event of removeButton
        const removeBtn = clone.querySelector('.js-remove-button');
        removeBtn.setAttribute('data-row-index', rowIndex);
        removeBtn.addEventListener('click', function(e) {
            // Get the row index
            const index = e.target.getAttribute('data-row-index');
            removeRow(index);
        });
      });

      // botones tabla, acción search
      $("#tbl_article").on('click','.searchButton',function(){
        // eliminar todos los campos dinamicos
        $('.removeButton').click();

        // Get the record's ID via attribute
        var id = $(this).attr('data-id');
        var csrftoken = getCookie('csrftoken');

        $.ajax({
          headers: { "X-CSRFToken": csrftoken },
          url: "{% url 'venta:seleccionar_lote' %}",
          method: 'GET',
          data: { id: id },
          success: function(response, textStatus, xhr) {
            if (response.success == true) {
              // Populate the form fields with the data returned from server
              $('#loteForm')
                .find('[name="id"]').val(response.id).end()
                .find('[name="producto"]').val(response.producto).end();

              // crea array input para posterior llenado
              var cesta_lote = JSON.parse(response.lotejson);
              for(var i=0;i<cesta_lote.length;i++) {
                // crear nuevo indice
                if (i > 0) {
                  $('.addButton').click();
                }
              }

              // Show the dialog
              bootbox
                .dialog({
                  title: 'Agregar Lote',
                  message: loteForm,
                  size: 'large',
                  onEscape: true,
                  show: false // We will show it manually later
                })
                .on('shown.bs.modal', function() {
                  // Show the cash form
                  loteForm.style.display = 'block';

                  // Reset form
                  fv_lote.resetForm(true);

                  // Populate the form fields with the data returned from server
                  for(var i=0;i<cesta_lote.length;i++) {
                    lote_item = cesta_lote[i];
                    $('#loteForm')
                      .find('[name="lote['+ i + '].etiqueta"]').val(lote_item.lote_numero).end()
                      .find('[name="lote[' + i + '].fecha_caducidad"]').val(lote_item.fecha_caducidad).end()
                      .find('[name="lote[' + i + '].cantidad"]').val(toFloat(lote_item.cantidad).toLocaleString()).end();
                  }

                })
                .on('hide.bs.modal', function() {
                  loteForm.style.display = 'none';
                  document.body.appendChild(loteForm);
                })
                .modal('show');

            } else {
              mensaje('No existe lote', 'error');
            }
          },
          error: function(xhr, textStatus, errorThrown) {
            mensaje(errorThrown, 'error');
          }
        });
      });

    });

    var TableData = new Array();
    $(document).ready(function() {
      $('[data-toggle="tooltip"]').tooltip();

      var items = new Bloodhound({
        datumTokenizer: Bloodhound.tokenizers.obj.whitespace('name'),
        queryTokenizer: Bloodhound.tokenizers.whitespace,
        prefetch: {
          cache: false, //SIN CACHE
          //url: "../ajax/product_lookup/",
          url: "{% url 'almacen:product_lookup' %}",
          filter: function (items) {
            return $.map(items, function (producto) {
              return {
                id: producto.producto_id,
                name: producto.nombre + ' - ' + producto.codigo_principal,
                existencia: producto.existencia
              };
            });
          }
        }
      });

      var services = new Bloodhound({
        datumTokenizer: Bloodhound.tokenizers.obj.whitespace('name'),
        queryTokenizer: Bloodhound.tokenizers.whitespace,
        prefetch: {
          cache: false, //SIN CACHE
          url: "{% url 'servicio:busqueda_servicios' %}",
          filter: function (services) {
            return $.map(services, function (service) {
              return {
                id: 'SRV-' + service.servicio_id,
                name: service.nombre + ' - SERV' + service.servicio_id
              };
            });
          }
        }
      });

      // Initialize the Bloodhound suggestion engine
      items.initialize();

      /*
      $('#scrollable-dropdown-menu .typeahead').typeahead({
        hint: true,
        highlight: true,
        minLength: 1
      },
      {
        limit: 50, // This controls the number of suggestions displayed
        displayKey: 'name',
        source: items.ttAdapter(),
        templates: {
          suggestion: function (data) {
            //return '<p><strong>' + data.name + '</strong> - '+ data.id +'</p>';
            return '<p>' + data.name + '<strong style="color:coral;"> <span class="glyphicon glyphicon-hand-right"></span> ' + parseFloat(data.existencia).toFixed(2) + '</strong></p>';
          }
        }
      },
      {
        name: 'service-list',
        display: 'name',
        source: services.ttAdapter(),
        templates: {
          header: '<h4 class="my-list">SERVICIOS</h4>'
        }
      }
      ).on('typeahead:selected', function($e, datum){
        var dataId = datum["id"];
        agregarItem(dataId);

        // borrar producto de input text typeahead
        $(this).typeahead('val', '');
        $(this).typeahead('close');
      }).on('typeahead:autocompleted', function(object, datum){
        $(this).trigger('typeahead:_done', [object, datum]);

        $(this).typeahead('val', '');
        $(this).typeahead('close');
      });*/

      // Instantiate the Typeahead UI
      $('#scrollable-dropdown-menu .typeahead').typeahead({
          hint: true,
          highlight: true, /* Enable substring highlighting */
          minLength: 1 /* Specify minimum characters required for showing suggestions */
      },
      {
          limit: 50, // This controls the number of suggestions displayed
          displayKey: 'name',
          source: items.ttAdapter(),
          templates: {
              header: '<h4 class="my-list">PRODUCTOS</h4>',
              suggestion: function (data) {
                //return '<p><strong>' + data.name + '</strong> - '+ data.id +'</p>';
                return '<p>' + data.name + '<strong style="color:coral;"> <i class="fas fa-hand-point-right"></i> ' + parseFloat(data.existencia).toFixed(2) + '</strong></p>';
              }
          }
      },
      {
          name: 'service-list',
          display: 'name',
          source: services.ttAdapter(),
          templates: {
              header: '<h4 class="my-list">SERVICIOS</h4>'
          }
      }
      ).on('typeahead:selected', function($e, datum){
          var dataId = datum["id"];
          agregarItem(dataId);

          // borrar producto de input text typeahead
          $(this).typeahead('val', '');
          $(this).typeahead('close');
      }).on('typeahead:autocompleted', function(object, datum){
          $(this).trigger('typeahead:_done', [object, datum]);

          // borra producto de input text typeahead
          $(this).typeahead('val', '');
          $(this).typeahead('close');
      }).on('typeahead:_done', function(evt, object, datum) {
          var dataId = datum["id"];
          agregarItem(dataId);
      }).on('keyup', this, function (event) {
          if (event.keyCode == 13) {
            // BUSCAR string en db (Tecla Enter y Lector de barras)
            var productId = $(this).typeahead('val');
            locateProductDB(productId);

            // borrar producto de input text typeahead
            $(this).typeahead('close');
          }
      });

      function locateProductDB($param) {
        if($param != '') {
          var csrftoken = getCookie('csrftoken');
          $.ajax({
            headers: { "X-CSRFToken": csrftoken },
            url: "{% url 'venta:localizar_agregar_elemento' %}",
            method: 'POST',
            data: { search_string: $param },
            dataType: 'json',
            success: function(response, textStatus, xhr) {
              if (response.success == true) {
                if (response.totalFilas == 1)
                {
                  // Quitar Fila: ¡ Ningún dato disponible en el carrito !
                  document.querySelectorAll("#tbl_article tbody tr").forEach(function(e){e.remove();});
                }

                // agregar item a la tabla
                $("#tbl_article tbody").append(response.markup);
                $("#lblSubtotal").text(response.subt_otal);
                $("#lblLocalDiscount").text(response.descuento);
                $("#lblSubtotalBase").text(response.tarifa_base);
                $("#lblSubtotalFree").text(response.tarifa_cero);
                $("#lblLocalTax").text(response.impuesto);
                $("#lblGrandTotal").text(response.total);
                $("#lblTotal").text(response.total);

                // borrar producto de input text typeahead
                $("#typeahead_producto").typeahead('val', '');
              } else {
                if (response.stock == 0) {
                  agregarItemSinExistencia(response.dataId);

                } else {
                  mensaje(response.message, 'error');
                }

                // borrar producto de input text typeahead
                $("#typeahead_producto").typeahead('val', '');
              }
            },
            error : function(xhr, textStatus, errorThrown) {
              mensaje(errorThrown, 'error');
            }
          });
        }
      }
    });
    // end document

    // función TYPEAHEAD para buscar clientes en db
    var clientes = new Bloodhound({
      datumTokenizer: Bloodhound.tokenizers.obj.whitespace('name'),
      queryTokenizer: Bloodhound.tokenizers.whitespace,
      prefetch: {
        cache: false, //SIN CACHE
        /*url: "<?=$this->basePath('ajax/get-customers')?>",*/
        url: "{% url 'venta:busquedaClientes' %}",
        filter: function (clientes) {
          return $.map(clientes, function (cliente) {
            return {
              id: cliente.cliente_id,
              name: cliente.nombre + ' - ' + cliente.identificacion
            };
          });
        }
      }
    });

    clientes.initialize();

    $('#prefetch_customer .typeahead').typeahead({
      hint: true,
      highlight: true,
      minLength: 1
    },
    {
      displayKey: 'name',
      source: clientes.ttAdapter(),
    }).on('typeahead:selected', function(object, datum){
      $(this).trigger('typeahead:_done', [object, datum]);
    }).on('typeahead:autocompleted', function(object, datum){
      $(this).trigger('typeahead:_done', [object, datum]);
    }).on('typeahead:_done', function(evt, object, datum) {
      var dataId = datum["id"];
      $("#txtRazonSocialID").val(dataId);

      var pos = datum["name"].indexOf(" - ");
      $(this).typeahead('val', datum["name"].substr(0, pos));
      $(this).typeahead('close');

    }).on('keydown', this, function (event) {
      if (event.keyCode == 13 || event.keyCode == 9) {
        const typeahead = $(this).data().ttTypeahead;
        const hintText = typeahead.input.$hint.val();
        const menu = typeahead.menu;
        const sel = menu.getActiveSelectable() || menu.getTopSelectable();
        if (menu.isOpen()) {
          menu.trigger('selectableClicked', sel);
          event.preventDefault();
        }
      } else {
        $("#txtRazonSocialID").val('0');
      }
    });

    // función para agregar item al carrito de ventas
    function agregarItem($param) {
      $.ajax({
        url: "{% url 'notaentrega:agregar_item' %}",
        data: { dataId: $param },
        dataType: 'json',
        success: function(response, textStatus, xhr) {
          //console.log(response);
          if (response.success == true) {
            //console.log("TOTAL FILAS CARRITO=" + response.totalFilas);
            if (response.totalFilas == 1)
            {
              // Quitar Fila: ¡ Ningún registro encontrado !
              document.querySelectorAll("#tbl_article tbody tr").forEach(function(e){e.remove();});
            }
            // agregar item a la tabla
            $("#tbl_article tbody").append(response.markup);
            $("#lblSubtotal").text(response.subtotal);
            $("#lblLocalDiscount").text(response.descuento);
            $("#lblSubtotalBase").text(response.tarifa_base);
            $("#lblSubtotalFree").text(response.tarifa_cero);
            $("#lblLocalTax").text(response.impuesto);
            $("#lblGrandTotal").text(response.total);
            $("#lblTotal").text(response.total);
          } else {
            if (response.stock == 0) {
              agregarItemSinExistencia(response.dataId);
            } else {
              mensaje(response.message, 'error');
            }
          }
        },
        error : function(xhr, textStatus, errorThrown) {
          mensaje(errorThrown, 'error');
        }
      });
    }

    function agregarItemSinExistencia(dataId)
    {
      $.confirm({
        title: 'Existencia insuficiente!',
        content: 'Desea facturar sin existencia?',
        buttons: {
          confirm: {
            text: 'Si, facturar!',
            btnClass: 'btn-blue',
            keys: ['enter', 'shift'],
            action: function(){
              // VENDER SIN STOCK
              $.ajax({
                url: "{% url 'notaentrega:agregar_item_sin_existencia' %}",
                data: { dataId: dataId },
                dataType: 'json',
                success: function(response, textStatus, xhr) {
                  if (response.success == true) {
                    if (response.totalFilas == 1)
                    {
                      // Quitar Fila: ¡ Ningún registro encontrado !
                      document.querySelectorAll("#tbl_article tbody tr").forEach(function(e){e.remove();});
                    }
                    // agregar item a la tabla
                    $("#tbl_article tbody").append(response.markup);
                    $("#lblSubtotal").text(response.subtotal);
                    $("#lblLocalDiscount").text(response.descuento);
                    $("#lblSubtotalBase").text(response.tarifa_base);
                    $("#lblSubtotalFree").text(response.tarifa_cero);
                    $("#lblLocalTax").text(response.impuesto);
                    $("#lblGrandTotal").text(response.total);
                    $("#lblTotal").text(response.total);
                  } else {
                    mensaje(response.message, 'error');
                  }
                },
                error : function(xhr, textStatus, errorThrown) {
                  mensaje(errorThrown, 'error');
                }
              });
            }
          },
          cancel: {
            text: 'No!',
            action: function(){
              //close
            }
          }
        }
      });
    }

    const editForm = document.getElementById('editItemForm');
    const fv_edit = FormValidation
      .formValidation(editForm, {
        fields: {
          qty: {
            validators: {
              numeric: {
                message: 'La cantidad debe ser un número',
                // The default separators
                thousandsSeparator: '',
                decimalSeparator: ','
              },
              callback: {
                message: 'Por favor especifique una cantidad válida.',
                callback: function(value, validator, $field) {
                  //var channel = $('#surveyForm').find('[name="channel"]:checked').val();
                  var cantidad = $('#editItemForm').find('[name="qty"]').val();
                  var equivalencia = $('#editItemForm').find('[name="equivalencia"]').val();
                  var unidad = $('#editItemForm').find('[name="unit"] option:selected').text();

                  //console.log(unidad);
                  if (unidad.substring(0, 2) != '* ') {
                    if ((toFloat(cantidad) < toFloat(equivalencia)) && (toFloat(cantidad) > 0)) {
                      return true;
                    } else {
                      return false;
                    }
                  } else {
                    return (toFloat(cantidad) > 0)
                          ? true
                          : false;
                  }
                }
              }
            }
          },
          unit: {
            validators: {
              notEmpty: {
                message: 'Por favor seleccione una unidad'
              },
            }
          },
          price: {
            validators: {
              numeric: {
                message: 'La cantidad debe ser un número',
                // The default separators
                thousandsSeparator: '',
                decimalSeparator: ','
              },
              notEmpty: {
                message: 'El valor no puede ser nulo'
              },
            }
          },
          discount: {
            validators: {
              numeric: {
                message: 'La cantidad debe ser un número',
                // The default separators
                thousandsSeparator: '',
                decimalSeparator: ','
              },
              notEmpty: {
                message: 'El valor no puede ser nulo'
              },
            }
          }
        },
        plugins: {
          trigger: new FormValidation.plugins.Trigger(),
          bootstrap: new FormValidation.plugins.Bootstrap(),
          submitButton: new FormValidation.plugins.SubmitButton(),
          icon: new FormValidation.plugins.Icon({
            valid: 'fa fa-check',
            invalid: 'fa fa-times',
            validating: 'fa fa-refresh',
          }),
        },
      })
      .on('core.form.valid', function() {

        var id = editForm.querySelector('[name="id"]').value;

        var data = {
          'id' : id
        };

        $.ajax({
          url: "{% url 'notaentrega:editar_item' %}",
          method: 'POST',
          data: $(editForm).serialize() + '&' + $.param(data),
          success: function(response, textStatus, xhr) {
            if (response.success == true) {
              // Get the cells
              var $button = $('button[data-id="' + response.id + '"]'),
              $tr     = $button.closest('tr'),
              $cells  = $tr.find('td');

              //var total_linea = response.cantidad * response.precio;
              // Update the cell data
              $cells
                .eq(2).html(response.cantidad).end()
                .eq(3).html(response.unidad).end()
                .eq(4).html(response.precio).end()
                .eq(5).html(response.total_linea).end();

              // Hide the dialog
              $(editForm).parents('.bootbox').modal('hide');

              $("#lblSubtotal").text(response.subtotal);
              $("#lblLocalDiscount").text(response.descuento);
              $("#lblSubtotalBase").text(response.tarifa_base);
              $("#lblSubtotalFree").text(response.tarifa_cero);
              $("#lblLocalTax").text(response.impuesto);
              $("#lblGrandTotal").text(response.total);
              $("#lblTotal").text(response.total);
            } else {
              // Ocultar el diálogo
              $(editForm).parents('.bootbox').modal('hide');

              var exchange_cart_id = response.exchange_cart_id;
              var exchange_qty = response.exchange_qty;
              var exchange_unit = response.exchange_unit;
              var exchange_price = response.exchange_price;
              var exchange_discount_percent = response.exchange_discount_percent;

              modifyItemWithoutStock(exchange_cart_id, exchange_qty, exchange_unit, exchange_price, exchange_discount_percent);
            }
          },
          error : function(xhr, textStatus, errorThrown) {
            mensaje(textStatus, 'error');
          }
        });
      });

    // cambiar precio si cambia unidad de medida
    $('#selectId').on('change', function () {
      var optionSelected = $("option:selected", this);
      var valueSelected = this.value;
      var text = $(this).find(":selected").text();

      var precio_actual = toFloat($('input[name="price"]').val());
      var equivalencia = $('input[name="equivalencia"]').val();

      if (text.substring(0, 2) == '* ') {
        // unidad principal
        var nuevo_precio = precio_actual * equivalencia;
        $('input[name="price"]').val(nuevo_precio.toLocaleString());

      } else {
        // unidad secundaria
        var nuevo_precio = precio_actual / equivalencia;
        $('input[name="price"]').val(nuevo_precio.toLocaleString());
      }
    });

    // botones tabla, acción editar
    $("#tbl_article").on('click','.editButton',function(){
      var id = $(this).attr('data-id');
      $.ajax({
        url: "{% url 'notaentrega:editar_item' %}",
        method: 'GET',
        data: { id: id },
        success: function(response, textStatus, xhr) {
          // eliminar unidades existentes y agrega unidad principal y secundaria
          $('#editItemForm')
            .find('[name="unit"]').children().remove().end()
            .append('<option selected value="' + response.unit_primary + '">* ' + response.unit_primary + '</option>');

          if (response.unit_secondary != null) {
            $('#editItemForm')
              .find('[name="unit"]')
              .append('<option selected value="' + response.unit_secondary + '">' + response.unit_secondary + '</option>');
          }

          // Show the dialog
          bootbox
            .dialog({
              title: 'Editar item del pedido',
              message: editForm,
              onEscape: true,
              show: false // We will show it manually later
            })
            .on('shown.bs.modal', function() {
              // Show the cash form
              editForm.style.display = 'block';

              // Reset form
              fv_edit.resetForm(true);

              // Populate the form fields with the data returned from server
              $('#editItemForm')
                .find('[name="id"]').val(response.id).end()
                .find('[name="product"]').val(response.product).end()
                .find('[name="qty"]').val(toFloat(response.qty).toLocaleString()).end()
                .find('[name="unit"]').val(response.unit).end()
                .find('[name="equivalencia"]').val(response.unit_equivalence).end()
                .find('[name="price"]').val(toFloat(response.price).toLocaleString()).end()
                .find('[name="discount"]').val(toFloat(response.discount).toLocaleString()).end();

              if (response.category == 'PROD') {
                // producto
                $('#medida_servicioFields').css('display', 'none');
                //$('#medida_productoFields').css('display', 'block');
                $('#editItemForm')
                  .find('[name="unit"]').val(response.unit).end();
              } else {
                // servicio
                //$('#medida_productoFields').css('display', 'none');
                $('#medida_servicioFields').css('display', 'block');
                $('#editItemForm')
                  .find('[name="unit_service"]').val(response.unit).end();
              }

              $('#editItemForm')
                .find('[name="qty"]').focus().select();
            })
            .on('hide.bs.modal', function() {

              editForm.style.display = 'none';
              document.body.appendChild(editForm);
            })
            .modal('show');
        },
        error : function(xhr, textStatus, errorThrown) {
          mensaje(textStatus, 'error');
        }
      });
    });

    // botones tabla, acción eliminar
    $("#tbl_article").on('click','.deleteButton',function(){
      var id = $(this).attr('data-id');
      $(this).closest('tr').remove();
      //agregar mensaje: ¡ No se ha encontrado ningún registro en el carrito !
      var rowCount = $("#tbl_article td").closest("tr").length;
      if (rowCount == 0) {
        var markup = "<tr><td colspan='6' style = 'text-align: center;' bgcolor='Gainsboro' data-title='Productos & Servicios'>"
        + "<font color='OrangeRed'>¡ Ningún registro encontrado !</font></td></tr>";
        $("#tbl_article tbody").append(markup);
      }

      var csrftoken = getCookie('csrftoken');
      $.ajax({
        headers: { "X-CSRFToken": csrftoken },
        url: "{% url 'notaentrega:eliminar_item' %}",
        method: 'POST',
        data: { itemId: id },
        dataType: 'json',
        success: function(response, textStatus, xhr) {
          // elimina item de la tabla
          $(this).closest('tr').remove();

          $("#lblSubtotal").text(response.subtotal);
          $("#lblLocalDiscount").text(response.descuento);
          $("#lblSubtotalBase").text(response.tarifa_base);
          $("#lblSubtotalFree").text(response.tarifa_cero);
          $("#lblLocalTax").text(response.impuesto);
          $("#lblGrandTotal").text(response.total);
          $("#lblTotal").text(response.total);
        },
        error : function(xhr, textStatus, errorThrown) {
          mensaje(textStatus, 'error');
        }
      });
    });

    // función modificar item sin existencia
    function modifyItemWithoutStock(exchange_cart_id, exchange_qty, exchange_unit, exchange_price, exchange_discount_percent)
    {
      $.confirm({
        title: 'Existencia insuficiente!',
        content: 'Desea facturar sin existencia?',
        buttons: {
          confirm: {
            text: 'Si, facturar!',
            btnClass: 'btn-blue',
            keys: ['enter', 'shift'],
            action: function(){
              // VENDER SIN STOCK
              var csrftoken = getCookie('csrftoken');
              $.ajax({
                headers: { "X-CSRFToken": csrftoken },
                url: "{% url 'notaentrega:editar_item_sin_existencia' %}",
                method: 'POST',
                data: { exchange_cart_id: exchange_cart_id, exchange_qty: exchange_qty, exchange_unit: exchange_unit, exchange_price: exchange_price, exchange_discount_percent: exchange_discount_percent },
                dataType: 'json',
                success: function(response, textStatus, xhr) {
                  if (response.success == true) {
                    // Get the cells
                    var $button = $('button[data-id="' + response.id + '"]'),
                    $tr     = $button.closest('tr'),
                    $cells  = $tr.find('td');

                    // Update the cell data
                    $cells
                    .eq(2).html(response.cantidad).end()
                    .eq(3).html(response.unidad).end()
                    .eq(4).html(response.precio).end()
                    .eq(5).html(response.total_linea).end();

                    // update cells
                    $("#lblSubtotal").text(response.subtotal);
                    $("#lblLocalDiscount").text(response.descuento);
                    $("#lblSubtotalBase").text(response.tarifa_base);
                    $("#lblSubtotalFree").text(response.tarifa_cero);
                    $("#lblLocalTax").text(response.impuesto);
                    $("#lblGrandTotal").text(response.total);
                    $("#lblTotal").text(response.total);
                  } else {
                    mensaje(response.message, 'error');
                  }
                },
                error : function(xhr, textStatus, errorThrown) {
                  mensaje(errorThrown, 'error');
                }
              });
            }
          },
          cancel: {
            text: 'No!',
            action: function(){
              //close
            }
          }
        }
      });
    }

    // botón vaciar carrito
    $('#empty_shopping_cart').click(function(e){
      e.preventDefault();
      $.ajax({
        url: "/cesta/vaciar_cesta/?key=CART-VENTA",
        success: function(response, textStatus, xhr) {
          //poner a cero subtotales
          setZero();
        },
        error: function(xhr, textStatus, errorThrown) {
          mensaje(errorThrown, 'error');
        }
      });
      return false;
    });

    // poner a cero factura
    function setZero() {
      $("#lblSubtotal").text(formatter.format(0));
      $("#lblLocalDiscount").text(formatter.format(0));
      $("#lblSubtotalBase").text(formatter.format(0));
      $("#lblSubtotalFree").text(formatter.format(0));
      $("#lblLocalTax").text(formatter.format(0));
      $("#lblGrandTotal").text(formatter.format(0));
      $("#lblTotal").text(formatter.format(0));

      //eliminar ref y razon social
      $("#typeahead_razon_social").val('');
      $("#txtRazonSocialID").val('0');
      var today = moment().format('YYYY-MM-DD');
      $('#datepicker').val(today);

      //eliminar pagos
      TableData = [];

      // eliminar tabla articulos
      document.querySelectorAll("#tbl_article tbody tr").forEach(function(e){e.remove()});

      // Agregar Fila: ¡ Ningún registro encontrado !
      var markup = "<tr><td colspan='6' style = 'text-align: center;' bgcolor='Gainsboro' data-title='Productos & Servicios'>"
      + "<font color='OrangeRed'>¡ Ningún registro encontrado !</font></td></tr>";

      $("#tbl_article tbody").append(markup);

      // eliminar pagos
      document.querySelectorAll("#tbl_payments tbody tr").forEach(function(e){e.remove()});

      // Agregar Fila: ¡ Ningún registro encontrado !
      var markup = "<tr><td colspan='4' style = 'text-align: center;' bgcolor='Gainsboro' data-title='Información de Pagos'>"
      + "<font color='OrangeRed'>¡ Ningún registro encontrado !</font></td></tr>";

      $("#tbl_payments tbody").append(markup);

      //$('#paymentForm')
      //  .formValidation('resetForm'); // Reset form
    }

    // obtener total de filas
    function rowCount(tabla) {
      var nFilas = $("#" + tabla + " tbody tr").length;
      if (nFilas == 1) {
        //verifica fila: ¡ Ningún registro encontrado !
        var childrenId = $("#" + tabla + " tr td")[0].innerHTML;
        var texto =  $("#" + tabla + " tr td:nth(0)").text();
        if (texto == "¡ Ningún registro encontrado !")
        {
          nFilas = 0;
        }
      }
      return nFilas;
    }

    // verifica si existe el item en la tabla
    function isExist(strd){
      // console.log($('tr[id*=output_newrow]').length)
      testme=false;
      $('#tbl_payments tr').each(function(){
        //console.log($('td:nth(1)',$(this)).text());
        //console.log(strd);
        if($('td:nth(1)',$(this)).text()===strd) {
          testme=true;
        }
      });
      return testme;
    }

    // borrar item tbl_payments
    $("#tbl_payments").on('click','.deleteButton',function(){
      //var id = $(this).attr('data-id');
      var codigo_tipo = $(this).closest('tr').find('td:nth-child(3)').text();
      $(this).closest('tr').remove();

      // eliminar pago del diccionario
      var vc = -1;
      var n = TableData.length;
      for (i = 0; i < n; i++) {
        vc = vc + 1;
        if (TableData[vc]['ptype'] == codigo_tipo) {
          TableData.splice(vc, 1);
          vc = vc - 1;
        }
      }

      //agregar mensaje: ¡ No se ha encontrado ningún registro !
      var rowCount = $("#tbl_payments td").closest("tr").length;
      if (rowCount == 0) {
        var markup = "<tr><td colspan='4' style = 'text-align: center;' bgcolor='Gainsboro' data-title='Información de Pagos'>"
        + "<font color='OrangeRed'>¡ Ningún registro encontrado !</font></td></tr>";
        $("#tbl_payments tbody").append(markup);
      }
    });

    // función guardar factura
    $('#saveButton').click(function(e){
      e.preventDefault();

      $.ajax({
        url: "/cesta/total_filas_cesta/?key=CART-VENTA",
        success: function(response, textStatus, xhr) {
          if (response.total_filas > 0) {
            var cliente_id = $("#txtRazonSocialID").val();
            var fecha_emision = $("#datepicker").val();
            var grand_total = $("#lblTotal").text();

            var csrftoken = getCookie('csrftoken');

            $.ajax({
              headers: { "X-CSRFToken": csrftoken },
              url:'../payment-detail/',
              type:'POST',
              data:{
                'cliente_id' : cliente_id,
                'fecha_emision': fecha_emision,
                'monto': grand_total,
                'csrfmiddlewaretoken': $('input[name=csrfmiddlewaretoken]').val(),
              },
              success:function(response){
                /*console.log("response from server...");
                console.log(response);*/

                //$('#modalPaymentView .modal-dialog').html($('#modalPaymentView .modal-dialog',data));
                //$('#modalPaymentView').modal('show');
                $('#dlg_cliente_id').val(response.cliente_id);
                $('#nombre_cliente').text(response.cliente);
                $('#dlg_fecha_emision').val(response.fecha_emision);

                $('#valor_factura').text(response.monto);
                $('#dlg_grand_total').val(response.monto);

                $('input[type=submit]').val('Pagar ' + response.monto);
                $('#modalPaymentView').modal('show');

              },
              error:function(){
                  console.log('error')
              },
            });

            /*
            if (rowCount('tbl_payments') > 0) {
              // sumatoria de pagos
              var sumatoria_pagos = 0
              $('#tbl_payments tr').each(function(row, tr){
                if (row > 0) {
                  var aux = $.trim($(tr).find('td:eq(3)').text());
                  sumatoria_pagos = sumatoria_pagos + toFloat(aux);
                }
              });

              var grand_total = toFloat($("#lblTotal").text());
              if (sumatoria_pagos == grand_total) {

                var fecha_emision = $("#datepicker").val();
                var cliente_id = $("#txtRazonSocialID").val();
                if (cliente_id == 0) {
                  cliente_id = 1
                }
                var firmar = true;
                var payment_method = '';

                TableData = JSON.stringify(TableData);
                var data = {
                  'cliente_id' : cliente_id,
                  'fecha_emision' : fecha_emision,
                  'firmar' : firmar,
                  'payment_method': payment_method,
                  'pTableData' : TableData
                };

                var csrftoken = getCookie('csrftoken');
                $.ajax({
                  headers: { "X-CSRFToken": csrftoken },
                  url: "{% url 'venta:guardar_factura' %}",
                  method: 'POST',
                  data: $.param(data),
                  dataType: 'json',
                  success: function(response, textStatus, xhr) {
                    //console.log("respuesta:" + response);
                    if (!response.success)
                      bootbox.alert('El ticket recibido no es válido');
                    else {
                      var facturaId = response.facturaId; //numero de orden
                      var PRTDEV = response.PRTDEV
                      //console.log("Imprimir tiket " + orderId);
                      $.confirm({
                        title: 'Imprimir!',
                        content: 'Desea imprimir recibo?',
                        type: 'green',
                        buttons: {
                          cancel: {
                            text: 'Cancelar',
                            action: function(){
                              //close
                            }
                          },
                          somethingElse: {
                            text: 'Si, imprimirlo!',
                            btnClass: 'btn-green',
                            keys: ['enter', 'shift'],
                            action: function(){

                              // IMPRIMIR FACTURA LAN
                              if (PRTDEV == 1 || PRTDEV == 2) {
                                // POS TERMINAL
                                var csrftoken = getCookie('csrftoken');
                                $.ajax({
                                  headers: { "X-CSRFToken": csrftoken },
                                  url: "{% url 'venta:imprimir_ticket' %}",
                                  type: 'POST',
                                  data: { facturaId: facturaId },
                                  dataType: 'json',
                                  success: function(response) {
                                    console.log(response);
                                  },
                                  error: function(xhr, textStatus, errorThrown) {
                                    mensaje('Oops... Error al imprimir', 'error');
                                  }
                                });
                              } else if (PRTDEV == 3) {
                                //MATRICIAL
                                var csrftoken = getCookie('csrftoken');
                                $.ajax({
                                  headers: { "X-CSRFToken": csrftoken },
                                  url: "{% url 'venta:imprimir_factura' %}",
                                  type: 'POST',
                                  data: { facturaId: facturaId },
                                  dataType: 'json',
                                  success: function(response) {
                                    console.log(response);
                                  },
                                  error: function(xhr, textStatus, errorThrown) {
                                    mensaje('Oops... Error al imprimir', 'error');
                                  }
                                });
                              } else if (PRTDEV >= 4 && PRTDEV <=5) {
                                //var accion =  "../render/pdf/" + facturaId
                                var accion =  "../../impresion/render/pdf/" + facturaId
                                $('#print_form').attr('action', accion);
                                $('#print_form').submit();
                              }
                              // fin print lan

                              /*
                              // generar ticket e imprimir NUEVO WEB
                              var csrftoken = getCookie('csrftoken');
                              $.ajax({
                                headers: { "X-CSRFToken": csrftoken },
                                url: "{% url 'venta:imprimir_ticket_interfaz_web' %}",
                                type: 'POST',
                                data: { facturaId: facturaId },
                                dataType: 'json',
                                success: function(response, textStatus, xhr) {
                                  console.log(response);
                                  //directPrintFile(printSocket, 'media/recibos/archivo_binario.bin');
                                  for (let step = 0; step < response.copies; step++) {
                                    directPrintFile(printSocket, response.file);

                                    location.reload(); // recargar página para impresora usb
                                  }
                                },
                                error : function(xhr, textStatus, errorThrown) {
                                  mensaje('Error al imprimir', 'error');
                                }
                              });
                              // fin print web
                              */
              /*              }
                          }
                        }
                      });

                      // poner a cero subtotales
                      setZero();
                    }
                  },
                  error : function(xhr, textStatus, errorThrown) {
                    $.alert({
                      icon: 'fas fa-bug',
                      title: 'Error!',
                      theme: 'material',
                      type: 'red',
                      content: 'Error al guardar comprobante',
                    });
                  }
                });
              } else {
                mensaje('El total del comprobante no coincide con la forma de pago.', 'error');
              }
            } else {
              mensaje('Ingrese la forma de pago del comprobante.', 'error');
            }*/

          } else {
            mensaje('¡ Ningún registro encontrado !', 'error')
          }
        },
        error : function(xhr, textStatus, errorThrown) {
          mensaje('Error al totalizar items', 'error');
        }
      });
    });

    /*function imprimir_ticket_test() {
      console.log("IMPRIMIENDO con browserify...");
      var csrftoken = getCookie('csrftoken');

      $.ajax({
        headers: { "X-CSRFToken": csrftoken },
        url: "{% url 'venta:imprimir_ticket_interfaz_web' %}",
        type: 'POST',
        data: { facturaId: 16 },
        dataType: 'json',
        success: function(response, textStatus, xhr) {
          console.log(response);
          //directPrintFile(printSocket, 'media/recibos/archivo_binario.bin');
          for (let step = 0; step < response.copies; step++) {
            directPrintFile(printSocket, response.file);
            location.reload();
          }
        },
        error : function(xhr, textStatus, errorThrown) {
          mensaje('Error al imprimir', 'error');
        }
      });

      return true;
    }*/

    /**
     *
     FUNCIONES FORMULARIOS MODALES
     */
    $('.js-cash-payment').click(function(e){
      var grand_total = toFloat($("#lblTotal").text());
      if (grand_total > 0) {
        $.confirm({
          title: 'Pago Efectivo',
          theme:'material',
          content: '' +
          '<form action="#" class="formName">' +
            '<div class="form-group text-center">' +
              '<label class="col-12 control-label" name="lblGrandTotal">Total a pagar: ' + $("#lblTotal").text() + ' </label>' +
            '</div>' +
            '<div class="form-group">' +
              '<label>Monto Recibido</label>' +
              '<input type="text" min="0" placeholder="0.00" class="form-control recibido" required ' +
                'style="font-size:20pt; font-weight: bold; color:red; text-align:center;" '+
                'id="dlg_recibido" value="' + grand_total+'"+/>'+
            '</div>' +
            '<div class="form-group text-center">' +
              '<label class="blinking" style="color: blue;">Cambio o Vuelto</label>' +
              '<label class="col-10 offset-1 control-label" ' +
                'style="text-align: center; font-size: 22pt; color: blue;" id="lblexchange_money"> 0 </label>' +
            '</div>' +
          '</form>',
          type: 'green',
          buttons: {
            formSubmit: {
              text: 'Pagar',
              btnClass: 'btn-green',
              action: function () {
                var recibido = this.$content.find('.recibido').val();
                if ((!recibido) || (recibido < grand_total)) {
                  $.alert('Monto inválido.');
                  return false;
                }

                var cliente_id = $("#txtRazonSocialID").val();
                var csrf_token = getCookie('csrftoken');

                $.ajax({
                  headers: { "X-CSRFToken": csrf_token },
                  url: "../sales_cash_payment/",
                  dataType: 'json',
                  method: 'post',
                  data: {
                    cliente_id: cliente_id,
                    grand_total: grand_total,
                    dlg_importe_recibido: recibido
                  },
                }).done(function (response) {
                  // guardar factura
                  if (response.success) {

                    var csrftoken = getCookie('csrftoken');
                    var data = {
                      'fecha_emision': $("#datepicker").val(),
                      'cliente_id': cliente_id,
                      'forma_pago': 'EF'
                    };

                    $.ajax({
                      headers: { "X-CSRFToken": csrftoken },
                      url: "{% url 'notaentrega:guardar_notaentrega' %}",
                      method: 'POST',
                      data: $.param(data),
                      dataType: 'json',
                      success: function(response, textStatus, xhr) {
                        if (!response.success)
                          mensaje('El token no es válido', 'error');
                        else {
                          var facturaId = response.facturaId; //numero de orden
                          var PRTDEV = response.PRTDEV
                          //console.log("Imprimir tiket " + orderId);
                          $.confirm({
                            title: 'Imprimir!',
                            content: 'Desea imprimir recibo?',
                            type: 'green',
                            buttons: {
                              cancel: {
                                text: 'Cancelar',
                                action: function(){
                                  //close
                                }
                              },
                              somethingElse: {
                                text: 'Si, imprimirlo!',
                                btnClass: 'btn-green',
                                keys: ['enter', 'shift'],
                                action: function(){

                                  // IMPRIMIR FACTURA LAN
                                  if (PRTDEV == 1 || PRTDEV == 2) {
                                    // POS TERMINAL
                                    var csrftoken = getCookie('csrftoken');
                                    $.ajax({
                                      headers: { "X-CSRFToken": csrftoken },
                                      url: "{% url 'venta:imprimir_ticket' %}",
                                      type: 'POST',
                                      data: { facturaId: facturaId },
                                      dataType: 'json',
                                      success: function(response) {
                                        console.log(response);
                                      },
                                      error: function(xhr, textStatus, errorThrown) {
                                        mensaje('Oops... Error al imprimir', 'error');
                                      }
                                    });
                                  } else if (PRTDEV == 3) {
                                    //MATRICIAL
                                    var csrftoken = getCookie('csrftoken');
                                    $.ajax({
                                      headers: { "X-CSRFToken": csrftoken },
                                      url: "{% url 'venta:imprimir_factura' %}",
                                      type: 'POST',
                                      data: { facturaId: facturaId },
                                      dataType: 'json',
                                      success: function(response) {
                                        console.log(response);
                                      },
                                      error: function(xhr, textStatus, errorThrown) {
                                        mensaje('Oops... Error al imprimir', 'error');
                                      }
                                    });
                                  } else if (PRTDEV >= 4 && PRTDEV <=5) {
                                    //var accion =  "../render/pdf/" + facturaId
                                    var accion =  "../../impresion/render/pdf/" + facturaId
                                    $('#print_form').attr('action', accion);
                                    $('#print_form').submit();
                                  }
                                  // fin print lan

                                  /*
                                  // generar ticket e imprimir NUEVO WEB
                                  var csrftoken = getCookie('csrftoken');
                                  $.ajax({
                                    headers: { "X-CSRFToken": csrftoken },
                                    url: "{% url 'venta:imprimir_ticket_interfaz_web' %}",
                                    type: 'POST',
                                    data: { facturaId: facturaId },
                                    dataType: 'json',
                                    success: function(response, textStatus, xhr) {
                                      console.log(response);
                                      //directPrintFile(printSocket, 'media/recibos/archivo_binario.bin');
                                      for (let step = 0; step < response.copies; step++) {
                                        directPrintFile(printSocket, response.file);

                                        location.reload(); // recargar página para impresora usb
                                      }
                                    },
                                    error : function(xhr, textStatus, errorThrown) {
                                      mensaje('Error al imprimir', 'error');
                                    }
                                  });*/
                                  // fin print web

                                }
                              }
                            }
                          });

                          // poner a cero subtotales
                          setZero();




                        }
                      },
                      error : function(xhr, textStatus, errorThrown) {
                        $.alert({
                          icon: 'fas fa-bug',
                          title: 'Error!',
                          theme: 'material',
                          type: 'red',
                          content: 'Error al guardar factura!',
                        });
                      }
                    });

                  } else {
                    mensaje('Error al procesar pago.', 'error');
                  }
                }).fail(function(){
                  mensaje("Error al procesar pago.", 'error');
                });
              }
            },
            formCancel: {
              text: 'Cancelar'
            },
          },
          onContentReady: function () {
            // RobinHerbots/Inputmask
            //$(".recibido").inputmask('currency',{rightAlign: true  });
            $(".recibido").inputmask('currency',{rightAlign: false  });

            this.$content.find('.recibido').focus().select();

            // bind to events
            var jc = this;
            this.$content.find('form').on('submit', function (e) {
              // if the user submits the form by pressing enter in the field.
              e.preventDefault();
              jc.$$formSubmit.trigger('click'); // reference the button and click it
            });

            // funcion cambio
            $('#dlg_recibido').on('input',function(e){
              var recibido = toFloat(this.value);
              var cambio = recibido - grand_total;

              if ($.isNumeric(cambio) || recibido === null) {
                var simbolo = getCurrencySymbol('en-US', 'USD');
                if (cambio > 0)
                  $("#lblexchange_money").text(simbolo + ' ' + cambio.toLocaleString());
                else
                  $("#lblexchange_money").text(simbolo + ' ' + '0'.toLocaleString());
              }
            });
          }
        });
      }
    });
  </script>

  <!-- FORMULARIOS DE PAGO -->

{% endblock extra_script %}
