{% extends "base.html" %}

{% block title %} Crear Proforma {% endblock title %}

{% load static %}

{% block extra_head %}
  <!-- librerías typeahead -->
  <link rel="stylesheet" type="text/css" href="{% static 'vendor/typeahead/css/typeaheadjs.css' %}">
  <link rel="stylesheet" type="text/css" href="{% static 'vendor/typeahead/css/typeaheadbundle.css' %}">

  <!-- librerías FormValidation -->
  <link rel="stylesheet" type="text/css" href="{% static 'vendor/formvalidation/css/formValidation.min.css' %}">

  <link rel="stylesheet" href="{% static 'css/_estilo_tabla_articulos.css' %}">

  <style>
    /* scrooll para typeahead */
    #scrollable-dropdown-menu .tt-menu {
      max-height: 250px;
      overflow-y: auto;
      /*background-color: red;*/
    }

    #prefetch_customer .tt-menu {
      max-height: 250px;
      overflow-y: auto;
    }

    /* estilo tabla adaptable */
    td.numeric, th.numeric { text-align: right; }
    #resultTable td.red {color: red; font-weight: bold}
    #resultTable td.coral {color: coral; font-weight: bold}

    /* scroll tabla carrito */
    .table-wrapper-scroll-y {
      display: block;
      max-height: 275px;
      overflow-y: auto;
      -ms-overflow-style: -ms-autohiding-scrollbar;
    }

    .imagebacked {
      padding: 10px 0 2px 40px;
      background-repeat: no-repeat;
      background-position: 1px 2px;
      vertical-align: middle;
    }

    /* Override to make the feedback icons shown properly */
    .form-horizontal .has-feedback .form-control-feedback {
      top: 0;
      right: -15px;
    }
    .form-horizontal .has-feedback .input-group .form-control-feedback {
      top: 0;
      right: -30px;
    }
  </style>
{% endblock extra_head %}

{% block content %}
<div class="base_container">
  <div class="col-12">
    <div class="row">
      <div class="col-6">
        <h4>Proforma</h4>
      </div>
      <div class="col-6">
        <div class="btn-group float-right" role="group" aria-label="Acciones">
          <button type="button" class="btn btn-primary btn-sm"
                  id="empty_shopping_cart">
                  <i class="fas fa-plus"></i> Nuevo
          </button>
          <button type="button" class="btn btn-secondary btn-sm"
                  onclick="location.href='{{ request.META.HTTP_REFERER }}';">
                  <i class="fas fa-undo"></i> Regresar
          </button>
        </div>
      </div>
    </div>
    <hr/>

    <div class="row">
      <div class="col-8">
        <div class="row">
          <!--<input type="hidden" name="txtRazonSocialID" id="txtRazonSocialID" value="0">
          <div class="col-md-8" id="prefetch_customer">
            <label for="typeahead_razon_social">Cliente</label>
            <div class="input-group">
              <input type="text" class="typeahead tt-query form-control" autocomplete="off" spellcheck="false" id="typeahead_razon_social" placeholder="Nombre o RUC">
              <span class="input-group-btn">
              <button type="button" id="addUnit" class="btn btn-default" onclick="return abrir_modal('{% url 'proforma:crear_cliente_modal' %}')">+</button>
              </span>
            </div>
          </div>
          -->
          <div class="col-md-8" id="prefetch_customer">
            <input type="hidden" name="txtRazonSocialID" id="txtRazonSocialID" value="0">
            <div class="form-group">
              <h5>Cliente</h5>
              <div id="prefetch_customer">
                <input type="text" class="form-control typeahead border-primary tt-query"
                  autocomplete="off" spellcheck="false" id="typeahead_razon_social" placeholder="Nombre o RUC" data-provide="typeahead">
              </div>
              <small class="float-right">Cliente no listado aquí? <a href="#" onclick="return abrir_modal('{% url 'venta:crear_cliente_modal' %}')">Agregar nuevo</a> </small>
            </div>
          </div>

          <div class="col-md-4">
            <label for="fday">Emisión Proforma</label>
            <input type="date" class="form-control" id="fday" value={{ fecha_emision }} placeholder="DD/MM/AAAA">
          </div>
        </div>
      </div>
      <!-- /.col-8 -->
      <div class="col-4">
        <div class="row">
                <div class="col-md-6">
            <label for="fvencimiento">Vencimiento Proforma</label>
            <input type="date" class="form-control" id="fvencimiento" value={{ fecha_expira }} placeholder="DD/MM/AAAA">
          </div>
          <div class="col-md-6">
            <label for="numero_comprobante">Nro. Proforma</label>
              <input type="text" class="form-control" id="numero_comprobante" data-inputmask="'mask': '999-999-999999999'" data-toggle="tooltip" title="Nro. Comprobante">
          </div>
          <!--<div class="col-md-6">
              <label for="guia_remision">Validez Proforma</label>
              <input type="text" class="form-control" id="guia_remision" placeholder="REF. VALIDO 8 DÍAS" maxlength="20" data-toggle="tooltip" title="REFERENCIA VALIDEZ PROFORMA">
          </div>-->
        </div>
      </div>
      <!-- /.col-4 -->
    </div>
    <!-- /.row -->

    <br>
    <div class="row">
      <div class="col-12 col-xl-8 mb-2">
        <div class="row">
          <div class="col-12">
            <div class="form-group">
              <div id="scrollable-dropdown-menu">
                <input type="text" class="typeahead tt-query form-control" autocomplete="off" spellcheck="false" id="typeahead_producto" placeholder="Buscar producto...">
              </div>
              <small class="float-right">Producto no listado aquí? <a href="#"data-toggle="modal" data-target="#addProductTypeModal">Agregar nuevo</a> </small>
            </div>
          </div>
        </div>

        <!-- Begin Table -->
        {% load my_filters %}

        <div class="card">
          <div class="card-body p-2">
            <div class="row">
              <div class="col-12">
                <div class="table-wrapper-scroll-y">
                  <section id="flip-scroll">
                    <table id="tbl_article" class="table table-bordered table-condensed cf">
                      <thead class="cf">
                        <tr>
                          <th style="display:none;">ID</th>
                          <th>Descripción</th>
                          <th class="numeric">Cantidad</th>
                          <th>Und</th>
                          <th class="numeric">Precio</th>
                          <th class="numeric">Total</th>
                          <th class="text-center">Acciones</th>
                        </tr>
                      </thead>

                      <tbody>
                        {% load concat_string %}

                        {% load cesta_tags %}
                        {% get_cesta "CART-PROFORMA" request.session.company_id as cesta %}

                        {% if cesta.obtener_items %}
                        {% for item in cesta.obtener_items %}
                        <tr>
                          <td style="display:none;">{{ item.product.pk }}</td>
                          {% if item.tipo == 'PROD' %}
                            <td data-title='Descripción'><a href=/producto/detalle_producto/{{item.producto.producto_id}} target='_blank'>{{ item.producto.nombre }}</a></td>
                          {% else %}
                            <td data-title='Descripción'><a href=/servicio/detalle_servicio/{{item.servicio.servicio_id}} target='_blank'>{{ item.servicio.nombre }}</a></td>
                          {% endif %}
                          <td class='numeric'>{{ item.cantidad|floatformat:2 }}</td>
                          <td>{{ item.unidad_medida.abreviatura }}</td>
                          <td class='numeric'>{{ item.precio|currency }}</td>
                          <td class='numeric'>{{ item.valor_subtotal_sin_impuesto|currency }}</td>
                          <td class="text-center">
                            {% if item.tipo == 'SERV' %}
                              <div class="btn-group btn-group-sm">
                                <button type="button"
                                  data-id="{{ 'SRV-'|concat_string:item.pk }}"
                                  class="btn btn-primary editButton"><i class='fas fa-edit'></i></button>
                              </div>
                              <div class="btn-group btn-group-sm">
                                <button type="button"
                                class="btn btn-info searchButton" disabled><i class='fas fa-search'></i></button>
                              </div>
                              <div class="btn-group btn-group-sm">
                                <button type="button"
                                  data-id="{{ 'SRV-'|concat_string:item.pk }}"
                                  class="btn btn-warning glyphicon deleteButton"><i class='fas fa-trash'></i></button>
                              </div>
                            {% else %}
                              <div class="btn-group btn-group-sm">
                                <button type="button" data-id="{{ item.pk }}"
                                  class="btn btn-primary editButton"><i class='fas fa-edit'></i></button>
                              </div>
                              <div class="btn-group btn-group-sm">
                                <button type="button" data-id="{{ item.pk }}"
                                  class="btn btn-warning deleteButton"><i class='fas fa-trash'></i></button>
                              </div>
                            {% endif %}
                          </td>
                        </tr>
                        {% endfor %}
                        {% endif %}
                        <!-- agregar mensaje NO HAY ITEMS -->
                        {% if cesta.obtener_total_filas == 0 %}
                        <tr>
                          <td colspan="6" style = "text-align: center;"
                          bgcolor="Gainsboro" data-title="Productos & Servicios"><font color="OrangeRed">¡ Ningún dato disponible en el carrito !</font></td>
                        </tr>
                        {% endif %}
                      </tbody>
                    </table>
                  </section>
                </div>
              </div>
            </div>
          </div>
          <!-- /.card-body -->
        </div>
      </div>
      <!-- /.col-xl-8 -->

      <div class="col-12 col-xl-4">
        <div class="card">
          <div class="card-header">
            <i class="fas fa-dollar-sign"></i> TOTAL
          </div>

          <div class="card-body">
            <div class="form-group text-center">
              <label class="col-12 control-label" id="lblGrandTotal" align="center"
                style="font-size: 40pt;">{{ cesta.obtener_gran_total|currency }}</label>
            </div>
            <div class="line col-10 offset-1" style="border-bottom: 1px solid #ccc;"></div>
            <!-- subtoal -->
            <div class="col-12">
              <br>
            </div>
            <div class="col-12">
              <label class="col-6">Subtotal</label>
              <label class="col-6 float-right"><span class="float-right" id="lblSubtotal">{{ cesta.obtener_sub_total|currency }}</span></label>
            </div>
            <div class="col-12">
              <label class="col-6">Descuento</label>
              <label class="col-6 float-right"><span class="float-right" id="lblLocalDiscount">{{ cesta.obtener_total_descuento|currency }}</span></label>
            </div>
            <div class="col-12">
              <label class="col-6">Tarifa 0%</label>
              <label class="col-6 float-right"><span class="float-right" id="lblSubtotalFree">{{ cesta.obtener_total_tarifa_cero|currency }}</span></label>
            </div>

            <div class="col-12">
              <label class="col-6">Tarifa {{ tarifa }}%</label>
              <label class="col-6 float-right"><span class="float-right" id="lblSubtotalBase">{{ cesta.obtener_base_imponible|currency }}</span></label>
            </div>

            <div class="col-12">
              <label class="col-6">Iva {{ tarifa }}%</label>
              <label class="col-6 float-right"><span class="float-right" id="lblLocalTax">{{ cesta.obtener_total_iva|currency }}</span></label>
            </div>
            <div class="col-12">
              <label class="col-6">TOTAL</label>
              <label class="col-6 float-right"><span class="float-right" id="lblTotal">{{ cesta.obtener_gran_total|currency }}</span></label>
            </div>
          </div>
        </div>
        <!-- /.card -->
      </div>
      <!-- /.col-xl-4 -->
    </div>
    <!-- /.row -->

    <div class="row">
      <div class="ln_solid"></div>
      <div class="form-group">
        <div class="col-12">
          <button onclick="location.href='{% url 'proforma:listado_proformas' %}';" class="btn btn-secondary btn-sm" type="button">Cancelar</button>
          <button id="saveButton" type="submit" class="btn btn-primary btn-sm">Guardar</button>
        </div>
      </div>
    </div>
    <!-- /.row -->
    </div>
    <!-- /.col-12 -->
  </div>
  <!-- /.base_container -->

  <!-- The form which is used to populate the item data -->
  <form id="editItemForm" method="post" class="form-horizontal" style="display: none;" autocomplete="off">
  	{% csrf_token %}
  	<input type="hidden" name="id" disabled="disabled" />
    <div class="form-group">
      <label for="product">Producto</label>
      <input type="text" class="form-control" name="product" disabled="disabled">
    </div>

    <div class="form-group row">
      <label class="col-sm-4 col-form-label" for="qty">Cantidad <span class="required">*</span>
      </label>
      <div class="col-sm-8">
        <input type="text" class="form-control" name="qty" />
      </div>
    </div>

    <div class="form-group row" id="medida_productoFields">
      <input type="hidden" name="equivalencia" />
      <label class="col-sm-4 col-form-label" for="unit">Unidad <span class="required">*</span>
      </label>
      <div class="col-sm-8">
        <select class="form-control" name="unit" id="selectId">
        </select>
      </div>
    </div>

    <div class="form-group row" id="medida_servicioFields" style="display: none;">
      <label class="col-sm-4 col-form-label" for="unit_service">Unidad <span class="required">*</span>
      </label>
      <div class="col-sm-8">
        <select  class="form-control" name="unit_service">
  				{% for unidad in unidades_servicio %}
  					<option value={{ unidad.abreviatura }}>{{ unidad.abreviatura }}</option>
  				{% endfor %}
  			</select>
      </div>
    </div>

    <div class="form-group row">
      <label class="col-sm-4 col-form-label" for="price">Precio <span class="required">*</span>
      </label>
      <div class="col-sm-8">
        <input type="text" class="form-control" name="price" />
      </div>
    </div>

    <div class="form-group row">
      <label class="col-sm-4 col-form-label" for="discount">Descuento % <span class="required">*</span>
      </label>
      <div class="col-sm-8">
        <input type="text" class="form-control" name="discount" />
      </div>
    </div>

  	<div class="form-group">
  		<div class="col-sm-3 float-right">
  			<button type="submit" class="btn btn-primary">Actualizar</button>
  		</div>
  	</div>
  </form>
  <!-- End editItemForm-->

	<!-- formulario modal proveedor -->
	<div id="popup" class="modal fade" role="dialog">

	</div>
{% endblock content %}

{% block extra_script %}
  <!-- librerías protección csrftoken -->
  <script src="{% static 'js/proteccion_csrf.js' %}"></script>

  <!-- librerías typeahead -->
  <script src="{% static 'vendor/typeahead/js/typeahead.bundle.js' %}"></script>

  <!-- librerías FormValidation -->
  <script src="{% static 'vendor/formvalidation/js/FormValidation.min.js' %}"></script>
  <script src="{% static 'vendor/formvalidation/js/plugins/Bootstrap.min.js' %}"></script>

  <!-- librerías bootbox -->
  <script src="{% static 'vendor/bootbox/bootbox.min.js' %}"></script>

  <!-- jquery.inputmask -->
  <script src="{% static 'vendor/inputmask/jquery.inputmask.min.js' %}"></script>

  <!-- INICIO JAVASCRIPT -->
  <script type="text/javascript">
    // Initialize InputMask
    $(":input").inputmask();

    $(document).ready(function(){
      $('[data-toggle="tooltip"]').tooltip();
    });

    // función para mostrar formulario modal cliente
    function abrir_modal(url)
    {
      $('#popup').load(url, function()
      {
        $(this).modal('show');
      });
      return false;
    }

    function cerrar_modal()
    {
      $('#popup').modal('hide');
      return false;
    }

    $(document).ready(function() {
      var items = new Bloodhound({
        datumTokenizer: Bloodhound.tokenizers.obj.whitespace('name'),
        queryTokenizer: Bloodhound.tokenizers.whitespace,
        prefetch: {
          cache: false, //SIN CACHE
          //url: "../ajax/product_lookup/",
          url: "{% url 'almacen:product_lookup' %}",
          filter: function (items) {
            return $.map(items, function (producto) {
              return {
                id: producto.producto_id,
                name: producto.nombre + ' - ' + producto.codigo_principal,
                existencia: producto.existencia
              };
            });
          }
        }
      });

      var services = new Bloodhound({
        datumTokenizer: Bloodhound.tokenizers.obj.whitespace('name'),
        queryTokenizer: Bloodhound.tokenizers.whitespace,
        prefetch: {
          cache: false, //SIN CACHE
          url: "{% url 'servicio:busqueda_servicios' %}",
          filter: function (services) {
            return $.map(services, function (service) {
              return {
                id: 'SRV-' + service.servicio_id,
                name: service.nombre + ' - SERV' + service.servicio_id
              };
            });
          }
        }
      });

      // Initialize the Bloodhound suggestion engine
      items.initialize();

      $('#scrollable-dropdown-menu .typeahead').typeahead({
        hint: true,
        highlight: true, /* Enable substring highlighting */
        minLength: 1 /* Specify minimum characters required for showing suggestions */
      },
      {
        limit: 50, // This controls the number of suggestions displayed
        displayKey: 'name',
        source: items.ttAdapter(),
        templates: {
          header: '<h5 class="my-list">PRODUCTOS</h5>',
          suggestion: function (data) {
            //return '<p><strong>' + data.name + '</strong> - '+ data.id +'</p>';
            return '<p>' + data.name + '<strong style="color:coral;"> <i class="fas fa-hand-point-right"></i> ' + parseFloat(data.existencia).toFixed(2) + '</strong></p>';
          }
        }
      },
      {
        name: 'service-list',
        display: 'name',
        source: services.ttAdapter(),
        templates: {
          header: '<h5 class="my-list">SERVICIOS</h5>'
        }
      }
      ).on('typeahead:selected', function($e, datum){
        var dataId = datum["id"];
        agregarItem(dataId);

        // borrar producto de input text typeahead
        $(this).typeahead('val', '');
        $(this).typeahead('close');
      }).on('typeahead:autocompleted', function(object, datum){
        $(this).trigger('typeahead:_done', [object, datum]);

        $(this).typeahead('val', '');
        $(this).typeahead('close');
      });
    });

    // función TYPEAHEAD para buscar clientes en db
    var clientes = new Bloodhound({
      datumTokenizer: Bloodhound.tokenizers.obj.whitespace('name'),
      queryTokenizer: Bloodhound.tokenizers.whitespace,
      prefetch: {
        cache: false, //SIN CACHE
        /*url: "<?=$this->basePath('ajax/get-customers')?>",*/
        url: "{% url 'venta:busquedaClientes' %}",
        filter: function (clientes) {
          return $.map(clientes, function (cliente) {
            return {
              id: cliente.cliente_id,
              name: cliente.nombre + ' - ' + cliente.identificacion
            };
          });
        }
      }
    });

    clientes.initialize();

    $('#prefetch_customer .typeahead').typeahead({
      hint: true,
      highlight: true,
      minLength: 1
    },
    {
      displayKey: 'name',
      source: clientes.ttAdapter(),
    }).on('typeahead:selected', function(object, datum){
      $(this).trigger('typeahead:_done', [object, datum]);
    }).on('typeahead:autocompleted', function(object, datum){
      $(this).trigger('typeahead:_done', [object, datum]);
    }).on('typeahead:_done', function(evt, object, datum) {
      var dataId = datum["id"];
      $("#txtRazonSocialID").val(dataId);

      var pos = datum["name"].indexOf(" - ");
      $(this).typeahead('val', datum["name"].substr(0, pos));
      $(this).typeahead('close');

    }).on('keydown', this, function (event) {
      if (event.keyCode == 13 || event.keyCode == 9) {
        const typeahead = $(this).data().ttTypeahead;
        const hintText = typeahead.input.$hint.val();
        const menu = typeahead.menu;
        const sel = menu.getActiveSelectable() || menu.getTopSelectable();
        if (menu.isOpen()) {
          menu.trigger('selectableClicked', sel);
          event.preventDefault();
        }
      } else {
        $("#txtRazonSocialID").val('0');
      }
    });

    // función para agregar item al carrito de proformas
    function agregarItem($param) {
      $.ajax({
        url: "{% url 'proforma:agregar_item' %}",
        data: { dataId: $param },
        dataType: 'json',
        success: function(response, textStatus, xhr) {
          //console.log("CARRITO=" + response.totalFilas);
          //console.log("TOTAL LINEAS=" + response.filas);
          if (response.success == true) {
            //console.log("TOTAL FILAS CARRITO=" + response.totalFilas);
            if (response.totalFilas == 1)
            {
              // Quitar Fila: ¡ Ningún registro encontrado !
              document.querySelectorAll("#tbl_article tbody tr").forEach(function(e){e.remove();});
            }
            // agregar item a la tabla
            $("#tbl_article tbody").append(response.markup);
            $("#lblSubtotal").text(response.subtotal);
            $("#lblLocalDiscount").text(response.descuento);
            $("#lblSubtotalBase").text(response.tarifa_base);
            $("#lblSubtotalFree").text(response.tarifa_cero);
            $("#lblLocalTax").text(response.impuesto);
            $("#lblGrandTotal").text(response.total);
            $("#lblTotal").text(response.total);
          } else {
            if (response.stock == 0) {
              agregarItemSinExistencia(response.dataId);
            } else {
              mensaje(response.message, 'error');
            }
          }
        },
        error : function(xhr, textStatus, errorThrown) {
          mensaje(textStatus, 'error');
        }
      });
    }

    function agregarItemSinExistencia(dataId)
    {
      $.confirm({
        title: 'Existencia insuficiente!',
        content: 'Desea proformar sin existencia?',
        buttons: {
          confirm: {
            text: 'Si, facturar!',
            btnClass: 'btn-blue',
            keys: ['enter', 'shift'],
            action: function(){
              // VENDER SIN STOCK
              $.ajax({
                url: "{% url 'proforma:agregar_item_sin_existencia' %}",
                data: { dataId: dataId },
                dataType: 'json',
                success: function(response, textStatus, xhr) {
                  if (response.success == true) {
                    if (response.totalFilas == 1)
                    {
                      // Quitar Fila: ¡ Ningún registro encontrado !
                      document.querySelectorAll("#tbl_article tbody tr").forEach(function(e){e.remove();});
                    }
                    // agregar item a la tabla
                    $("#tbl_article tbody").append(response.markup);
                    $("#lblSubtotal").text(response.subtotal);
                    $("#lblLocalDiscount").text(response.descuento);
                    $("#lblSubtotalBase").text(response.tarifa_base);
                    $("#lblSubtotalFree").text(response.tarifa_cero);
                    $("#lblLocalTax").text(response.impuesto);
                    $("#lblGrandTotal").text(response.total);
                    $("#lblTotal").text(response.total);
                  } else {
                    mensaje(response.message, 'error');
                  }
                },
                error : function(xhr, textStatus, errorThrown) {
                  mensaje(errorThrown, 'error');
                }
              });
            }
          },
          cancel: {
            text: 'No!',
            action: function(){
              //close
            }
          }
        }
      });
    }

    // botones tabla, acción editar
    $("#tbl_article").on('click','.editButton',function(){
      var id = $(this).attr('data-id');
      $.ajax({
        url: "{% url 'proforma:editar_item' %}",
        method: 'GET',
        data: { id: id },
        success: function(response, textStatus, xhr) {
          // eliminar unidades existentes y agrega unidad principal y secundaria
          $('#editItemForm')
            .find('[name="unit"]').children().remove().end()
            .append('<option selected value="' + response.unit_primary + '">* ' + response.unit_primary + '</option>');

          if (response.unit_secondary != null) {
            $('#editItemForm')
              .find('[name="unit"]')
              .append('<option selected value="' + response.unit_secondary + '">' + response.unit_secondary + '</option>');
          }

          // Show the dialog
          bootbox
            .dialog({
              title: 'Editar item del pedido',
              message: editForm,
              onEscape: true,
              show: false // We will show it manually later
            })
            .on('shown.bs.modal', function() {
              // Show the cash form
              editForm.style.display = 'block';

              // Reset form
              fv_edit.resetForm(true);

              // Populate the form fields with the data returned from server
              $('#editItemForm')
                .find('[name="id"]').val(response.id).end()
                .find('[name="product"]').val(response.product).end()
                .find('[name="qty"]').val(toFloat(response.qty).toLocaleString()).end()
                .find('[name="unit"]').val(response.unit).end()
                .find('[name="equivalencia"]').val(response.unit_equivalence).end()
                .find('[name="price"]').val(toFloat(response.price).toLocaleString()).end()
                .find('[name="discount"]').val(toFloat(response.discount).toLocaleString()).end();

              if (response.category == 'PROD') {
                // producto
                $('#medida_servicioFields').css('display', 'none');
                //$('#medida_productoFields').css('display', 'block');
                $('#editItemForm')
                	.find('[name="unit"]').val(response.unit).end();
              } else {
                // servicio
                //$('#medida_productoFields').css('display', 'none');
                $('#medida_servicioFields').css('display', 'block');
                $('#editItemForm')
                	.find('[name="unit_service"]').val(response.unit).end();
              }

              $('#editItemForm')
                .find('[name="qty"]').focus().select();
            })
            .on('hide.bs.modal', function() {

              editForm.style.display = 'none';
              document.body.appendChild(editForm);
            })
            .modal('show');
        },
        error : function(xhr, textStatus, errorThrown) {
          mensaje(textStatus, 'error');
        }
      });
    });

    // botones tabla, acción eliminar
    $("#tbl_article").on('click','.deleteButton',function(){
      var id = $(this).attr('data-id');
      $(this).closest('tr').remove();
      //agregar mensaje: ¡ No se ha encontrado ningún registro en el carrito !
      var rowCount = $("#tbl_article td").closest("tr").length;
      if (rowCount == 0) {
        var markup = "<tr><td colspan='6' style = 'text-align: center;' bgcolor='Gainsboro'>"
        + "<font color='OrangeRed'>¡ Ningún registro encontrado !</font></td></tr>";
        $("#tbl_article tbody").append(markup);
      }

      var csrftoken = getCookie('csrftoken');
      $.ajax({
        headers: { "X-CSRFToken": csrftoken },
        url: "{% url 'proforma:eliminar_item' %}",
        method: 'POST',
        data: { itemId: id },
        dataType: 'json',
        success: function(response, textStatus, xhr) {
          // elimina item de la tabla
          $(this).closest('tr').remove();

          $("#lblSubtotal").text(response.subtotal);
          $("#lblLocalDiscount").text(response.descuento);
          $("#lblSubtotalBase").text(response.tarifa_base);
          $("#lblSubtotalFree").text(response.tarifa_cero);
          $("#lblLocalTax").text(response.impuesto);
          $("#lblGrandTotal").text(response.total);
          $("#lblTotal").text(response.total);
        },
        error : function(xhr, textStatus, errorThrown) {
          mensaje(textStatus, 'error');
        }
      });
    });

  // cambiar precio si cambia unidad de medida
  $('#selectId').on('change', function () {
    var optionSelected = $("option:selected", this);
    var valueSelected = this.value;
    var text = $(this).find(":selected").text();

    var precio_actual = $('input[name="price"]').val();
    var equivalencia = $('input[name="equivalencia"]').val();

    if (text.substring(0, 2) == '* ') {
      // unidad principal
      var nuevo_precio = precio_actual * equivalencia;
      $('input[name="price"]').val(nuevo_precio.toFixed(5));

    } else {
      // unidad secundaria
      var nuevo_precio = precio_actual / equivalencia;
      $('input[name="price"]').val(nuevo_precio.toFixed(5));
    }
  });

  // formulario modal editItemForm
  const editForm = document.getElementById('editItemForm');
  const fv_edit = FormValidation
    .formValidation(editForm, {
      fields: {
        qty: {
          validators: {
            numeric: {
              message: 'La cantidad debe ser un número',
              // The default separators
              thousandsSeparator: '',
              decimalSeparator: ','
            },
            callback: {
              message: 'Por favor especifique una cantidad válida.',
              callback: function(value, validator, $field) {
                //var channel = $('#surveyForm').find('[name="channel"]:checked').val();
                var cantidad = $('#editItemForm').find('[name="qty"]').val();
                var equivalencia = $('#editItemForm').find('[name="equivalencia"]').val();
                var unidad = $('#editItemForm').find('[name="unit"] option:selected').text();

                //console.log(unidad);
                if (unidad.substring(0, 2) != '* ') {
                  if ((toFloat(cantidad) < toFloat(equivalencia)) && (toFloat(cantidad) > 0)) {
                    return true;
                  } else {
                    return false;
                  }
                } else {
                  return (toFloat(cantidad) > 0)
                        ? true
                        : false;
                }
              }
            }
          }
        },
        unit: {
          validators: {
            notEmpty: {
              message: 'Por favor seleccione una unidad'
            },
          }
        },
        price: {
          validators: {
            numeric: {
              message: 'La cantidad debe ser un número',
              // The default separators
              thousandsSeparator: '',
              decimalSeparator: ','
            },
            notEmpty: {
              message: 'El valor no puede ser nulo'
            },
          }
        },
        discount: {
          validators: {
            numeric: {
              message: 'La cantidad debe ser un número',
              // The default separators
              thousandsSeparator: '',
              decimalSeparator: ','
            },
            notEmpty: {
              message: 'El valor no puede ser nulo'
            },
          }
        },
      },
      plugins: {
        trigger: new FormValidation.plugins.Trigger(),
        bootstrap: new FormValidation.plugins.Bootstrap(),
        submitButton: new FormValidation.plugins.SubmitButton(),
        icon: new FormValidation.plugins.Icon({
          valid: 'fa fa-check',
          invalid: 'fa fa-times',
          validating: 'fa fa-refresh',
        }),
      },
    })
    .on('core.form.valid', function() {

      var id = editForm.querySelector('[name="id"]').value;

      var data = {
        'id' : id
      };

      $.ajax({
        url: "{% url 'proforma:editar_item' %}",
        method: 'POST',
        data: $(editForm).serialize() + '&' + $.param(data),
        success: function(response, textStatus, xhr) {
          if (response.success == true) {
            // Get the cells
            var $button = $('button[data-id="' + response.id + '"]'),
            $tr     = $button.closest('tr'),
            $cells  = $tr.find('td');

            // Update the cell data
            $cells
            .eq(2).html(response.cantidad).end()
            .eq(3).html(response.unidad).end()
            .eq(4).html(response.precio).end()
            .eq(5).html(response.total_linea).end();

            // Hide the dialog
            $(editForm).parents('.bootbox').modal('hide');

            $("#lblSubtotal").text(response.subtotal);
            $("#lblLocalDiscount").text(response.descuento);
            $("#lblSubtotalBase").text(response.tarifa_base);
            $("#lblSubtotalFree").text(response.tarifa_cero);
            $("#lblLocalTax").text(response.impuesto);
            $("#lblGrandTotal").text(response.total);
            $("#lblTotal").text(response.total);
          } else {
            // Ocultar el diálogo
            $(editForm).parents('.bootbox').modal('hide');
            var exchange_cart_id = response.exchange_cart_id;
            var exchange_qty = response.exchange_qty;
            var exchange_unit = response.exchange_unit;
            var exchange_price = response.exchange_price;
            var exchange_discount_percent = response.exchange_discount_percent;

            modifyItemWithoutStock(exchange_cart_id, exchange_qty, exchange_unit, exchange_price, exchange_discount_percent);
          }
        },
        error : function(xhr, textStatus, errorThrown) {
          mensaje(textStatus, 'error');
        }
      });
    });

    // función modificar item sin existencia
    function modifyItemWithoutStock(exchange_cart_id, exchange_qty, exchange_unit, exchange_price, exchange_discount_percent)
    {
      $.confirm({
        title: 'Existencia Insuficiente!',
        content: 'Desea facturar sin existencia?',
        type: 'green',
        buttons: {
          cancel: {
            text: 'Cancelar',
            action: function(){
              //close
            }
          },
          somethingElse: {
            text: 'Si, proformar!',
            btnClass: 'btn-green',
            keys: ['enter', 'shift'],
            action: function(){
              var csrftoken = getCookie('csrftoken');
              $.ajax({
                headers: { "X-CSRFToken": csrftoken },
                url: "{% url 'proforma:editar_item_sin_existencia' %}",
                method: 'POST',
                data: { exchange_cart_id: exchange_cart_id, exchange_qty: exchange_qty, exchange_unit: exchange_unit, exchange_price: exchange_price, exchange_discount_percent: exchange_discount_percent },
                dataType: 'json',
                success: function(response, textStatus, xhr) {
                  if (response.success == true) {
                    // Get the cells
                    var $button = $('button[data-id="' + response.id + '"]'),
                    $tr     = $button.closest('tr'),
                    $cells  = $tr.find('td');

                    var total_linea = response.cantidad * response.precio;
                    // Update the cell data
                    $cells
                    .eq(2).html(response.cantidad).end()
                    .eq(3).html(response.unidad).end()
                    .eq(4).html(formatter.format(response.precio)).end()
                    .eq(5).html(formatter.format(total_linea)).end();

                    // update cells
                    $("#lblSubtotal").text(response.subtotal);
                    $("#lblLocalDiscount").text(response.descuento);
                    $("#lblSubtotalBase").text(response.tarifa_base);
                    $("#lblSubtotalFree").text(response.tarifa_cero);
                    $("#lblLocalTax").text(response.impuesto);
                    $("#lblGrandTotal").text(response.total);
                    $("#lblTotal").text(response.total);
                  } else {
                    mensaje(response.message, 'error');
                  }
                },
                error : function(xhr, textStatus, errorThrown) {
                  mensaje(errorThrown, 'error');
                }
              });
            }
          }
        }
      });
    }

    // botón vaciar carrito
    $('#empty_shopping_cart').click(function(e){
      e.preventDefault();
      $.ajax({
        url: "/cesta/vaciar_cesta/?key=CART-PROFORMA",
        success: function(response, textStatus, xhr) {
          //poner a cero subtotales
          setZero();
        },
        error: function(xhr, textStatus, errorThrown) {
          mensaje(errorThrown, 'error');
        }
      });
      return false;
    });

    // poner a cero factura
    function setZero() {
      $("#lblSubtotal").text(formatter.format(0));
      $("#lblLocalDiscount").text(formatter.format(0));
      $("#lblSubtotalBase").text(formatter.format(0));
      $("#lblSubtotalFree").text(formatter.format(0));
      $("#lblLocalTax").text(formatter.format(0));
      $("#lblGrandTotal").text(formatter.format(0));
      $("#lblTotal").text(formatter.format(0));

      //eliminar ref y razon social
      $("#typeahead_razon_social").val('');
      $("#txtRazonSocialID").val('0');
      var today = moment().format('YYYY-MM-DD');
      $('#fday').val(today);

      // eliminar tabla articulos
      document.querySelectorAll("#tbl_article tbody tr").forEach(function(e){e.remove()});

      // Agregar Fila: ¡ Ningún registro encontrado !
      var markup = "<tr><td colspan='6' style = 'text-align: center;' bgcolor='Gainsboro'>"
      + "<font color='OrangeRed'>¡ Ningún registro encontrado !</font></td></tr>";

      $("#tbl_article tbody").append(markup);

      // eliminar pagos
      document.querySelectorAll("#tbl_payments tbody tr").forEach(function(e){e.remove()});

      // Agregar Fila: ¡ Ningún registro encontrado !
      var markup = "<tr><td colspan='4' style = 'text-align: center;' bgcolor='Gainsboro'>"
      + "<font color='OrangeRed'>¡ Ningún registro encontrado !</font></td></tr>";

      $("#tbl_payments tbody").append(markup);

      //$('#paymentForm')
      //  .formValidation('resetForm'); // Reset form
    }

    // obtener total de filas
    function rowCount(tabla) {
      var nFilas = $("#" + tabla + " tbody tr").length;
      if (nFilas == 1) {
        //verifica fila: ¡ Ningún registro encontrado !
        var childrenId = $("#" + tabla + " tr td")[0].innerHTML;
        var texto =  $("#" + tabla + " tr td:nth(0)").text();
        if (texto == "¡ Ningún registro encontrado !")
        {
          nFilas = 0;
        }
      }
      return nFilas;
    }

    // verifica si existe el item en la tabla
    function isExist(strd){
      // console.log($('tr[id*=output_newrow]').length)
      testme=false;
      $('#tbl_payments tr').each(function(){
        //console.log($('td:nth(1)',$(this)).text());
        //console.log(strd);
        if($('td:nth(1)',$(this)).text()===strd) {
          testme=true;
        }
      });
      return testme;
    }


    // función guardar factura
    $('#saveButton').click(function(e){
      e.preventDefault();

      $.ajax({
        url: "/cesta/total_filas_cesta/?key=CART-PROFORMA",
        success: function(response, textStatus, xhr) {
          if (response.total_filas > 0) {
            if (rowCount('tbl_payments') > 0) {
              // sumatoria de pagos
              var sumatoria_pagos = 0
              $('#tbl_payments tr').each(function(row, tr){
                if (row > 0) {
                  var aux = $.trim($(tr).find('td:eq(3)').text());
                  sumatoria_pagos = sumatoria_pagos + parseFloat(aux);
                }
              });
              sumatoria_pagos = sumatoria_pagos.toFixed(2);
              var grand_total_str = $("#lblTotal").text();
              var grand_total = Number(grand_total_str.replace(/[^0-9.-]+/g,"")).toFixed(2);

              //console.log("TOTAL A SUMATORIA = " + sumatoria_pagos)
              //console.log("TOTAL COMPROBANTE = " + grand_total)

              if (sumatoria_pagos == grand_total) {

                var fecha_emision = $("#fday").val();
                var fecha_vencimiento = $("#fvencimiento").val();
                var cliente_id = $("#txtRazonSocialID").val();
                if (cliente_id == 0) {
                  cliente_id = 1
                }

                var data = {
                  'cliente_id' : cliente_id,
                  'fecha_emision' : fecha_emision,
                  'fecha_vencimiento': fecha_vencimiento,
                };

                var csrftoken = getCookie('csrftoken');
                /*$.ajax({
                  headers: { "X-CSRFToken": csrftoken },
                  url: "{% url 'proforma:guardar_proforma' %}",
                  method: 'POST',
                  data: $.param(data),
                  dataType: 'json',
                }).success(function(response) {
                  //console.log("respuesta:" + response);
                  if (!response.success)
                  bootbox.alert('El ticket recibido no es válido');
                  else {
                    swal({
                      title: "Proforma exitosa",
                      text: "Desea imprimir recibo?",
                      type: "info",
                      showCancelButton: true,
                      confirmButtonClass: "btn-danger",
                      confirmButtonText: "Si, imprimirlo!",
                      cancelButtonText: "No, cancelar!",
                      closeOnConfirm: true
                    },
                    function(){
                      // IMPRIMIR FACTURA
                      var proformaId = response.proformaId; //numero de proforma

                      var accion = "../render/pdf/" + proformaId
                      $('#my_form').attr('action', accion);
                      $('#my_form').submit();

                    });
                    // poner a cero subtotales
                    setZero();
                  }
                }).fail(function(xhr, textStatus, errorThrown) {
                  swal("Oops... Error al guardar comprobante", errorThrown, "error");
                });*/

                $.ajax({
                  url: "{% url 'proforma:guardar_proforma' %}",
                  method: 'POST',
                  data: $.param(data),
                  dataType: 'json',
                  success: function(response, textStatus, xhr) {
                    //console.log("respuesta:" + response);
                    if (!response.success)
                      bootbox.alert('El ticket recibido no es válido');
                    else {
                      $.confirm({
                        title: 'Imprimir!',
                        content: 'Desea imprimir la proforma?',
                        type: 'green',
                        buttons: {
                          cancel: {
                            text: 'Cancelar',
                            action: function(){
                              //close
                            }
                          },
                          somethingElse: {
                            text: 'Si, imprimir!',
                            btnClass: 'btn-green',
                            keys: ['enter', 'shift'],
                            action: function(){
                              // IMPRIMIR FACTURA
                              var proformaId = response.proformaId; //numero de proforma

                              var accion = "../render/pdf/" + proformaId
                              $('#my_form').attr('action', accion);
                              $('#my_form').submit();
                            }
                          }
                        }
                      });

                      // poner a cero subtotales
                      setZero();
                    }
                  },
                  error : function(xhr, textStatus, errorThrown) {
                    mensaje(textStatus, 'error');
                  }
                });

              } else {
                mensaje('El total del comprobante no coincide con la forma de pago', 'error');
              }
            } else {
              // ==================================
              // PROFORMA SIN PAGO => SIN TRANSACCIÓN EN INVENTARIO
              // ==================================
              var fecha_emision = $("#fday").val();
              var fecha_vencimiento = $("#fvencimiento").val();
              var cliente_id = $("#txtRazonSocialID").val();
              if (cliente_id == 0) {
                cliente_id = 1
              }

              var data = {
                'cliente_id' : cliente_id,
                'fecha_emision' : fecha_emision,
                'fecha_vencimiento': fecha_vencimiento,
              };

              var csrftoken = getCookie('csrftoken');
              $.ajax({
                headers: { "X-CSRFToken": csrftoken },
                url: "{% url 'proforma:guardar_proforma' %}",
                method: 'POST',
                data: $.param(data),
                dataType: 'json',
                success: function(response, textStatus, xhr) {
                  //console.log(response);

                  if (!response.success)
                    bootbox.alert('El ticket recibido no es válido');
                  else {
                    $.confirm({
                      title: 'Imprimir!',
                      content: 'Desea imprimir proforma?',
                      type: 'green',
                      buttons: {
                        cancel: {
                          text: 'Cancelar',
                          action: function(){
                            //close
                          }
                        },
                        somethingElse: {
                          text: 'Si, imprimir!',
                          btnClass: 'btn-green',
                          keys: ['enter', 'shift'],
                          action: function(){
                            // IMPRIMIR FACTURA
                            var proformaId = response.proformaId;
                            //var accion = "../imprimir_proforma/" + proformaId + "/"
                            //proformas/render/pdf/125
                            var accion = "../render/pdf/" + proformaId
                            //var accion = "../render/pdf/"
                            $('#my_form').attr('action', accion);
                            //$("#my_form_data").val(proformaId);
                            $('#my_form').submit();
                          }
                        }
                      }
                    });

                    // poner a cero subtotales
                    setZero();
                  }
                },
                error : function(xhr, textStatus, errorThrown) {
                  mensaje(textStatus, 'error');
                }
              });
            }
          } else {
            mensaje('¡ Ningún registro encontrado !', 'error');
          }
        },
        error : function(xhr, textStatus, errorThrown) {
          mensaje(textStatus, 'error');
        }
      });
    });
  </script>
{% endblock extra_script %}
